<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety App - Government Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- Web3Modal and WalletConnect -->
    <script src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
    <script src="https://unpkg.com/evm-chains@0.2.0/dist/umd/index.min.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.1/dist/umd/index.min.js"></script>
    <style>
        /* All existing CSS styles remain unchanged */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --danger-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --light-bg: #f8f9fa;
            --dark-bg: #212529;
            --light-text: #212529;
            --dark-text: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --gov-color: #2a9d8f;
            --gov-secondary: #264653;
            /* High contrast colors */
            --high-contrast-primary: #0056b3;
            --high-contrast-secondary: #004085;
            --high-contrast-danger: #bd2130;
            --high-contrast-success: #1e7e34;
            --high-contrast-warning: #d39e00;
        }
        [data-theme="dark"] {
            --light-bg: #212529;
            --dark-bg: #f8f9fa;
            --light-text: #f8f9fa;
            --dark-text: #212529;
        }
        [data-theme="high-contrast"] {
            --primary-color: var(--high-contrast-primary);
            --secondary-color: var(--high-contrast-secondary);
            --danger-color: var(--high-contrast-danger);
            --success-color: var(--high-contrast-success);
            --warning-color: var(--high-contrast-warning);
            --light-bg: #ffffff;
            --dark-bg: #000000;
            --light-text: #000000;
            --dark-text: #ffffff;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: var(--transition);
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .gov-header {
            background-color: var(--gov-color);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .logo i {
            margin-right: 0.5rem;
        }
        .nav-icons {
            display: flex;
            gap: 1rem;
            position: relative;
        }
        .nav-icons i {
            font-size: 1.2rem;
            cursor: pointer;
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 120px);
        }
        .bottom-nav {
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .nav-items {
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.8rem;
            transition: var(--transition);
        }
        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        .nav-item.active {
            color: var(--secondary-color);
        }
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }
        [data-theme="dark"] .card {
            background-color: #343a40;
        }
        [data-theme="high-contrast"] .card {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }
        .btn i {
            margin-right: 0.5rem;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover {
            background-color: #d90479;
        }
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-success:hover {
            background-color: #00b4d8;
        }
        .btn-gov {
            background-color: var(--gov-color);
            color: white;
        }
        .btn-gov:hover {
            background-color: var(--gov-secondary);
        }
        .btn-block {
            display: block;
            width: 100%;
        }
        .sos-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--danger-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(247, 37, 133, 0.5);
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(247, 37, 133, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(247, 37, 133, 0);
            }
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: var(--transition);
        }
        [data-theme="dark"] .form-control {
            background-color: #495057;
            border-color: #6c757d;
            color: white;
        }
        [data-theme="high-contrast"] .form-control {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
            color: var(--dark-text);
            font-weight: 500;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .flex {
            display: flex;
        }
        .flex-column {
            flex-direction: column;
        }
        .justify-between {
            justify-content: space-between;
        }
        .align-center {
            align-items: center;
        }
        .text-center {
            text-align: center;
        }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .hidden {
            display: none !important;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.hidden {
            display: none !important;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        [data-theme="dark"] .modal-content {
            background-color: #343a40;
        }
        [data-theme="high-contrast"] .modal-content {
            background-color: var(--light-bg);
            border: 3px solid var(--dark-text);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }
        .close:hover {
            color: #000;
        }
        [data-theme="dark"] .close:hover {
            color: #fff;
        }
        [data-theme="high-contrast"] .close {
            color: var(--dark-text);
            font-weight: bold;
        }
        [data-theme="high-contrast"] .close:hover {
            color: var(--danger-color);
        }
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: white;
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            border-radius: 5px;
            box-shadow: var(--card-shadow);
            max-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification.success {
            border-left-color: var(--success-color);
        }
        .notification.warning {
            border-left-color: var(--warning-color);
        }
        .notification.error {
            border-left-color: var(--danger-color);
        }
        [data-theme="high-contrast"] .notification {
            border-left-width: 6px;
            font-weight: 500;
        }
        .profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }
        .profile-img-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            margin-bottom: 1rem;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: var(--success-color);
            display: inline-block;
            margin-left: 0.5rem;
        }
        .status-indicator.inactive {
            background-color: #6c757d;
        }
        .language-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
        }
        .language-option {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .language-option:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .language-option.selected {
            background-color: var(--primary-color);
            color: white;
        }
        .accessibility-options {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .accessibility-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .safety-tips {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .tip-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: var(--transition);
        }
        [data-theme="dark"] .tip-card {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .tip-card {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .tip-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .tip-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }
        .zone-map {
            height: 300px;
            background-color: #e9ecef;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        [data-theme="dark"] .zone-map {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .zone-map {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .safe-zone {
            position: absolute;
            background-color: rgba(76, 201, 240, 0.3);
            border: 2px solid var(--success-color);
            border-radius: 50%;
        }
        .risk-zone {
            position: absolute;
            background-color: rgba(247, 37, 133, 0.3);
            border: 2px solid var(--danger-color);
            border-radius: 50%;
        }
        .user-location {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--primary-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.3);
            z-index: 10;
        }
        .product-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
        }
        .product-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 1rem;
        }
        .product-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .product-price {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        [data-theme="dark"] .chat-messages {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .chat-messages {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .message {
            margin-bottom: 1rem;
            display: flex;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-content {
            max-width: 70%;
            padding: 0.75rem;
            border-radius: 8px;
        }
        .message.ai .message-content {
            background-color: #e9ecef;
            border-bottom-left-radius: 0;
        }
        [data-theme="dark"] .message.ai .message-content {
            background-color: #6c757d;
        }
        [data-theme="high-contrast"] .message.ai .message-content {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
            color: var(--dark-text);
        }
        .message.user .message-content {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0;
        }
        .chat-input {
            display: flex;
            gap: 0.5rem;
        }
        .chat-input input {
            flex: 1;
        }
        .weather-widget {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        [data-theme="dark"] .weather-widget {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .weather-widget {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .weather-icon {
            font-size: 2rem;
            color: var(--warning-color);
        }
        .weather-info h3 {
            margin-bottom: 0.25rem;
        }
        .countdown {
            font-size: 3rem;
            font-weight: bold;
            color: var(--danger-color);
            text-align: center;
            margin: 1rem 0;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Government Dashboard Styles */
        .gov-dashboard {
            padding: 2rem 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: var(--transition);
        }
        [data-theme="dark"] .stat-card {
            background-color: #343a40;
        }
        [data-theme="high-contrast"] .stat-card {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        [data-theme="high-contrast"] .stat-label {
            color: var(--dark-text);
            font-weight: 500;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 1rem;
        }
        .alert-item {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--danger-color);
            background-color: #f8f9fa;
            transition: var(--transition);
        }
        [data-theme="dark"] .alert-item {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .alert-item {
            background-color: var(--light-bg);
            border-left-width: 6px;
            border: 2px solid var(--dark-text);
        }
        .alert-item:hover {
            box-shadow: var(--card-shadow);
        }
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .alert-title {
            font-weight: 600;
        }
        .alert-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .alert-location {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .alert-actions {
            display: flex;
            gap: 0.5rem;
        }
        .evidence-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .evidence-form .form-group:last-child {
            grid-column: span 2;
        }
        .prediction-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--warning-color);
        }
        [data-theme="dark"] .prediction-card {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .prediction-card {
            background-color: var(--light-bg);
            border-left-width: 6px;
            border: 2px solid var(--dark-text);
        }
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .prediction-title {
            font-weight: 600;
        }
        .prediction-confidence {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background-color: var(--warning-color);
            color: white;
        }
        .prediction-details {
            font-size: 0.9rem;
        }
        .demo-credentials {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }
        [data-theme="dark"] .demo-credentials {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .demo-credentials {
            background-color: var(--light-bg);
            border-left-width: 6px;
            border: 2px solid var(--dark-text);
        }
        .credentials-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        .credentials-info {
            font-size: 0.9rem;
        }
        /* Enhanced Map Styles */
        .map-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .map-control-btn {
            width: 36px;
            height: 36px;
            background-color: white;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .map-control-btn:hover {
            background-color: #f0f0f0;
        }
        .map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .map-info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
        }
        .info-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .info-content {
            font-size: 0.8rem;
        }
        .incident-popup {
            font-size: 0.9rem;
        }
        .popup-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--danger-color);
        }
        .popup-details {
            margin-bottom: 3px;
        }
        .popup-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .popup-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .map-search {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 300px;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            margin: 10px;
            min-width: 200px;
        }
        /* Alert Log Styles */
        .alert-log-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .alert-log-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .alert-log-item:last-child {
            border-bottom: none;
        }
        .alert-log-type {
            font-weight: bold;
            margin-right: 10px;
        }
        .alert-log-type.anomaly {
            color: var(--warning-color);
        }
        .alert-log-type.geofence {
            color: var(--danger-color);
        }
        .alert-log-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .anomaly-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .anomaly-indicator.normal {
            background-color: var(--success-color);
        }
        .anomaly-indicator.warning {
            background-color: var(--warning-color);
        }
        .anomaly-indicator.critical {
            background-color: var(--danger-color);
        }
        /* Wallet Connection Styles */
        .wallet-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .wallet-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        .wallet-option:hover {
            background-color: var(--light-bg);
            border-color: var(--primary-color);
        }
        .wallet-option img {
            width: 50px;
            height: 50px;
            margin-bottom: 0.5rem;
        }
        .wallet-info {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: var(--light-bg);
            border-radius: 8px;
        }
        .wallet-status {
            margin-left: auto;
            font-size: 0.9rem;
            color: var(--success-color);
        }
        .method-selection {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        [data-theme="dark"] .method-selection {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .method-selection {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .method-option {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        .method-option:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        .method-option input[type="radio"] {
            margin-right: 1rem;
        }
        .method-description {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .qr-container {
            text-align: center;
            margin-top: 2rem;
        }
        .qr-container canvas {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background-color: white;
        }
        .qr-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: left;
        }
        [data-theme="dark"] .qr-info {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .qr-info {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .qr-info h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        .qr-info p {
            margin-bottom: 0.5rem;
        }
        /* Profile Picture Styles */
        .profile-upload {
            position: relative;
            display: inline-block;
        }
        .profile-upload .profile-img {
            cursor: pointer;
            transition: var(--transition);
        }
        .profile-upload .profile-img:hover {
            opacity: 0.8;
        }
        .profile-upload .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
            cursor: pointer;
        }
        .profile-upload:hover .upload-overlay {
            opacity: 1;
        }
        .profile-upload .upload-overlay i {
            color: white;
            font-size: 1.5rem;
        }
        .profile-upload input[type="file"] {
            display: none;
        }
        .profile-preview {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .profile-crop-container {
            max-width: 100%;
            margin: 0 auto;
        }
        .crop-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .btn-loading {
            position: relative;
            color: transparent;
        }
        .btn-loading .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-color: rgba(255,255,255,0.3);
            border-top-color: white;
        }
        /* Notification Dropdown Styles */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1001;
            margin-top: 10px;
        }
        [data-theme="dark"] .notification-dropdown {
            background-color: #343a40;
        }
        [data-theme="high-contrast"] .notification-dropdown {
            background-color: var(--light-bg);
            border: 3px solid var(--dark-text);
        }
        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        [data-theme="dark"] .notification-header {
            border-bottom-color: #495057;
        }
        [data-theme="high-contrast"] .notification-header {
            border-bottom: 2px solid var(--dark-text);
        }
        .notification-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .notification-clear {
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
        }
        .notification-clear:hover {
            text-decoration: underline;
        }
        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
        }
        [data-theme="dark"] .notification-item {
            border-bottom-color: #495057;
        }
        [data-theme="high-contrast"] .notification-item {
            border-bottom: 2px solid var(--dark-text);
        }
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        [data-theme="dark"] .notification-item:hover {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .notification-item:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .notification-item.unread {
            background-color: rgba(67, 97, 238, 0.1);
        }
        [data-theme="dark"] .notification-item.unread {
            background-color: rgba(67, 97, 238, 0.2);
        }
        [data-theme="high-contrast"] .notification-item.unread {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .notification-item-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .notification-item-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .notification-item-content {
            font-size: 0.9rem;
            color: #495057;
            line-height: 1.4;
        }
        [data-theme="dark"] .notification-item-content {
            color: #adb5bd;
        }
        [data-theme="high-contrast"] .notification-item-content {
            color: var(--dark-text);
        }
        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: #6c757d;
        }
        .notification-type-icon {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        .notification-type-icon.success {
            color: var(--success-color);
        }
        .notification-type-icon.warning {
            color: var(--warning-color);
        }
        .notification-type-icon.error {
            color: var(--danger-color);
        }
        /* Voice Assistant Button */
        .voice-assistant-btn {
            position: fixed;
            bottom: 160px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.5);
            cursor: pointer;
            z-index: 98;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .voice-assistant-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }
        .voice-assistant-btn.listening {
            background-color: var(--danger-color);
            animation: pulse 1s infinite;
        }
        /* Voice Assistant Modal */
        .voice-modal {
            position: fixed;
            bottom: 230px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 1rem;
            width: 300px;
            z-index: 97;
            transform: translateY(20px);
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }
        .voice-modal.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }
        .voice-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .voice-modal-title {
            font-weight: 600;
            font-size: 1rem;
        }
        .voice-modal-close {
            cursor: pointer;
            color: #6c757d;
        }
        .voice-modal-content {
            font-size: 0.9rem;
            color: #495057;
        }
        [data-theme="dark"] .voice-modal {
            background-color: #343a40;
        }
        [data-theme="high-contrast"] .voice-modal {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        [data-theme="dark"] .voice-modal-content {
            color: #adb5bd;
        }
        [data-theme="high-contrast"] .voice-modal-content {
            color: var(--dark-text);
        }
        
        /* Device Permissions Styles */
        .permissions-list {
            margin-top: 1.5rem;
        }
        .permission-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }
        [data-theme="dark"] .permission-item {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .permission-item {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .permission-item:hover {
            box-shadow: var(--card-shadow);
        }
        .permission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .permission-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        .permission-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e9ecef;
            font-size: 0.9rem;
            color: #6c757d;
        }
        [data-theme="dark"] .permission-details {
            border-top-color: #495057;
            color: #adb5bd;
        }
        [data-theme="high-contrast"] .permission-details {
            border-top-color: var(--dark-text);
            color: var(--dark-text);
        }
        .permission-status {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        .permission-status .status-indicator {
            margin-left: 0;
            margin-right: 0.5rem;
        }
        .permission-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .permission-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .permission-btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .permission-btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .permission-description {
            margin-bottom: 0.5rem;
        }
        .permission-reason {
            font-style: italic;
            margin-top: 0.5rem;
        }
        
        /* MFA Styles */
        .mfa-settings {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        [data-theme="dark"] .mfa-settings {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .mfa-settings {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .mfa-section {
            margin-bottom: 1.5rem;
        }
        .mfa-section:last-child {
            margin-bottom: 0;
        }
        .mfa-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
        }
        .mfa-method {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background-color: white;
            transition: var(--transition);
        }
        [data-theme="dark"] .mfa-method {
            background-color: #343a40;
        }
        [data-theme="high-contrast"] .mfa-method {
            background-color: var(--light-bg);
            border: 1px solid var(--dark-text);
        }
        .mfa-method:hover {
            box-shadow: var(--card-shadow);
        }
        .mfa-method-icon {
            font-size: 1.25rem;
            margin-right: 1rem;
            color: var(--primary-color);
        }
        .mfa-method-info {
            flex: 1;
        }
        .mfa-method-name {
            font-weight: 600;
        }
        .mfa-method-desc {
            font-size: 0.85rem;
            color: #6c757d;
        }
        [data-theme="dark"] .mfa-method-desc {
            color: #adb5bd;
        }
        [data-theme="high-contrast"] .mfa-method-desc {
            color: var(--dark-text);
        }
        .mfa-status {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }
        .mfa-status .status-indicator {
            margin-left: 0;
            margin-right: 0.5rem;
        }
        .mfa-action {
            margin-left: 1rem;
        }
        .mfa-code-input {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            font-weight: 600;
        }
        .mfa-timer {
            text-align: center;
            margin-top: 0.5rem;
            color: #6c757d;
        }
        [data-theme="dark"] .mfa-timer {
            color: #adb5bd;
        }
        [data-theme="high-contrast"] .mfa-timer {
            color: var(--dark-text);
        }
        .mfa-resend {
            text-align: center;
            margin-top: 1rem;
        }
        .mfa-resend a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .mfa-resend a:hover {
            text-decoration: underline;
        }
        
        /* Linked Devices Styles */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        .badge-success {
            color: #fff;
            background-color: var(--success-color);
        }
        
        /* Data Usage Styles */
        .data-usage-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        [data-theme="dark"] .data-usage-summary {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .data-usage-summary {
            background-color: var(--light-bg);
            border: 2px solid var(--dark-text);
        }
        .data-usage-progress {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        [data-theme="dark"] .data-usage-progress {
            background-color: #495057;
        }
        .data-usage-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .data-usage-progress-bar.warning {
            background-color: var(--warning-color);
        }
        .data-usage-progress-bar.danger {
            background-color: var(--danger-color);
        }
        .data-usage-feature {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }
        [data-theme="dark"] .data-usage-feature {
            border-bottom-color: #495057;
        }
        .data-usage-feature:last-child {
            border-bottom: none;
        }
        .data-usage-feature-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #f8f9fa;
            margin-right: 1rem;
        }
        [data-theme="dark"] .data-usage-feature-icon {
            background-color: #495057;
        }
        .data-usage-feature-info {
            flex: 1;
        }
        .data-usage-feature-name {
            font-weight: 600;
        }
        .data-usage-feature-usage {
            font-size: 0.9rem;
            color: #6c757d;
        }
        [data-theme="dark"] .data-usage-feature-usage {
            color: #adb5bd;
        }
        .data-usage-feature-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* Ad Choices Styles */
        .ad-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .ad-category-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            transition: var(--transition);
        }
        [data-theme="dark"] .ad-category-item {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .ad-category-item {
            background-color: var(--light-bg);
            border: 1px solid var(--dark-text);
        }
        .ad-category-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        .ad-category-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .ad-identifier-display {
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            word-break: break-all;
        }
        [data-theme="dark"] .ad-identifier-display {
            background-color: #495057;
            color: #adb5bd;
        }
        [data-theme="high-contrast"] .ad-identifier-display {
            background-color: var(--light-bg);
            border: 1px solid var(--dark-text);
            color: var(--dark-text);
        }
        .ad-history-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: var(--transition);
        }
        [data-theme="dark"] .ad-history-item {
            background-color: #495057;
        }
        [data-theme="high-contrast"] .ad-history-item {
            background-color: var(--light-bg);
            border: 1px solid var(--dark-text);
        }
        .ad-history-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        .ad-history-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            color: var(--primary-color);
        }
        .ad-history-info {
            flex: 1;
        }
        .ad-history-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .ad-history-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        [data-theme="dark"] .ad-history-time {
            color: #adb5bd;
        }
        [data-theme="high-contrast"] .ad-history-time {
            color: var(--dark-text);
        }
        
        /* Proactive SOS Styles */
        .progress {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        [data-theme="dark"] .progress {
            background-color: #495057;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.6s ease;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .safety-tips {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
            .evidence-form {
                grid-template-columns: 1fr;
            }
            .evidence-form .form-group:last-child {
                grid-column: span 1;
            }
            .map-search {
                width: 200px;
            }
            .map-info-panel {
                max-width: 150px;
            }
            .notification-dropdown {
                width: 280px;
                right: -10px;
            }
            .voice-modal {
                width: 250px;
                right: 10px;
            }
            .permission-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .permission-header .toggle-switch {
                margin-top: 0.75rem;
            }
            .mfa-method {
                flex-direction: column;
                align-items: flex-start;
            }
            .mfa-method-info {
                margin-top: 0.5rem;
            }
            .mfa-action {
                margin-left: 0;
                margin-top: 0.75rem;
                width: 100%;
            }
            .data-usage-summary {
                flex-direction: column;
                align-items: flex-start;
            }
            .ad-category-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-header" id="appHeader">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>Safety App</span>
                </div>
                <div class="nav-icons">
                    <div style="position: relative;">
                        <i class="fas fa-bell" id="notificationIcon"></i>
                        <span class="notification-badge hidden" id="notificationBadge">0</span>
                        <div class="notification-dropdown hidden" id="notificationDropdown">
                            <div class="notification-header">
                                <div class="notification-title">Notifications</div>
                                <div class="notification-clear" id="clearNotifications">Clear All</div>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-empty">No notifications</div>
                            </div>
                        </div>
                    </div>
                    <i class="fas fa-cog" id="settingsIcon"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="main-content">
        <div class="container">
            <!-- Home Page -->
            <div id="homePage" class="page active">
                <div class="card">
                    <div class="card-header">
                        <div class="flex align-center">
                            <h2 class="card-title">Hello, User!</h2>
                            <span class="status-indicator"></span>
                        </div>
                        <div class="profile-upload">
                            <img src="https://picsum.photos/seed/user123/80/80.jpg" alt="Profile" class="profile-img" id="homeProfileImg">
                            <div class="upload-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                            <input type="file" id="homeProfileUpload" accept="image/*">
                        </div>
                    </div>
                    <p>Welcome to your personal safety companion. Stay safe and connected with your loved ones.</p>
                </div>
                
                <!-- AI/ML Status Card -->
                <div class="card" id="aiStatusCard" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">AI/ML Safety Monitor</h3>
                        <span class="status-indicator" id="aiStatusIndicator"></span>
                    </div>
                    <div class="flex align-center mb-2">
                        <i class="fas fa-brain" style="font-size: 1.5rem; color: var(--primary-color); margin-right: 1rem;"></i>
                        <div>
                            <p><strong>Status:</strong> <span id="aiStatusText">Monitoring</span></p>
                            <p><strong>Threat Level:</strong> <span id="threatLevel">Low</span></p>
                        </div>
                    </div>
                    <div class="progress" style="height: 10px; background-color: #e9ecef;">
                        <div class="progress-bar" id="threatProgressBar" role="progressbar" style="width: 15%; background-color: var(--success-color);"></div>
                    </div>
                </div>
                
                <div class="grid">
                    <div class="card">
                        <h3 class="card-title">Incident Report</h3>
                        <p>Report any safety incidents or concerns in your area.</p>
                        <button class="btn btn-primary mt-2" id="reportIncidentBtn">
                            <i class="fas fa-exclamation-triangle"></i> Report Incident
                        </button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Health Monitoring</h3>
                        <p>Track your health metrics and receive alerts.</p>
                        <div class="flex justify-between mt-2">
                            <div class="text-center">
                                <i class="fas fa-heartbeat" style="font-size: 2rem; color: var(--danger-color);"></i>
                                <p>Heart Rate</p>
                                <p><strong>72 bpm</strong></p>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-walking" style="font-size: 2rem; color: var(--success-color);"></i>
                                <p>Steps</p>
                                <p><strong>5,234</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Safety Monitoring</h3>
                    <div class="flex align-center mb-2">
                        <i class="fas fa-map-marker-alt" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        <p><strong>Current Location:</strong> Home</p>
                    </div>
                    <div class="flex align-center mb-2">
                        <i class="fas fa-bluetooth-b" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        <p><strong>Bluetooth:</strong> <span id="bluetoothStatus">Off</span></p>
                        <button class="btn btn-primary ml-auto" id="toggleBluetooth">Turn On</button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Safety Tips</h3>
                    <div class="safety-tips">
                        <div class="tip-card">
                            <i class="fas fa-eye"></i>
                            <h4>Be Aware</h4>
                            <p>Stay alert of your surroundings</p>
                        </div>
                        <div class="tip-card">
                            <i class="fas fa-lock"></i>
                            <h4>Secure Valuables</h4>
                            <p>Keep your belongings safe</p>
                        </div>
                        <div class="tip-card">
                            <i class="fas fa-bus"></i>
                            <h4>Transportation</h4>
                            <p>Use trusted transport options</p>
                        </div>
                        <div class="tip-card">
                            <i class="fas fa-gavel"></i>
                            <h4>Local Regulations</h4>
                            <p>Know the local laws</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Map Page -->
            <div id="mapPage" class="page">
                <div class="card">
                    <div class="weather-widget">
                        <i class="fas fa-sun weather-icon"></i>
                        <div class="weather-info">
                            <h3>Sunny, 28C</h3>
                            <p>Feels like 30C  Humidity: 65%</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Interactive Safety Map</h3>
                        <div class="flex align-center">
                            <select class="form-control" id="mapLayerSelect" style="width: auto;">
                                <option value="street">Street View</option>
                                <option value="satellite">Satellite</option>
                                <option value="terrain">Terrain</option>
                            </select>
                            <button class="btn btn-primary btn-sm ml-2" id="refreshMapBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="map-container" style="height: 500px;">
                        <div id="userMap" style="height: 100%; width: 100%; border-radius: 8px;"></div>
                        <div class="map-search">
                            <input type="text" class="search-input" placeholder="Search location..." id="mapSearchInput">
                        </div>
                        <div class="map-controls">
                            <button class="map-control-btn" id="userMapZoomIn" title="Zoom In">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="map-control-btn" id="userMapZoomOut" title="Zoom Out">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="map-control-btn" id="userMapLocate" title="Locate Me">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            <button class="map-control-btn" id="userMapFullscreen" title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        <div class="map-legend">
                            <div class="legend-title">Legend</div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--success-color);"></div>
                                <span>Safe Zone</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--danger-color);"></div>
                                <span>Risk Area</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--warning-color);"></div>
                                <span>Incident</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--primary-color);"></div>
                                <span>Your Location</span>
                            </div>
                        </div>
                        <div class="map-info-panel">
                            <div class="info-title">Map Information</div>
                            <div class="info-content">
                                <p>Zoom: <span id="mapZoomLevel">13</span></p>
                                <p>Center: <span id="mapCenter">28.6139 N, 77.2090 E</span></p>
                                <p>Incidents: <span id="mapIncidentCount">3</span></p>
                            </div>
                        </div>
                        <div class="map-loading hidden" id="mapLoading">
                            <i class="fas fa-spinner fa-spin"></i> Loading map...
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-primary">
                            <i class="fas fa-download"></i> Download Maps
                        </button>
                    </div>
                </div>
            </div>
            <!-- Emergency Support Page -->
            <div id="emergencyPage" class="page">
                <div class="card">
                    <h3 class="card-title">Emergency Support</h3>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message ai">
                                <div class="message-content">
                                    Hello! I'm your AI emergency assistant. How can I help you today?
                                </div>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" class="form-control" id="chatInput" placeholder="Type your message...">
                            <button class="btn btn-primary" id="sendMessageBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Contacts Section -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Emergency Contacts</h3>
                        <button class="btn btn-primary btn-sm" onclick="navigateToEmergencyContacts()">
                            <i class="fas fa-cog"></i> Manage
                        </button>
                    </div>
                    <div id="emergencyPageContactsList">
                        <!-- Contacts will be loaded here -->
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">Emergency Services</h3>
                    <div class="grid">
                        <div class="flex align-center">
                            <i class="fas fa-phone-alt" style="font-size: 1.5rem; color: var(--danger-color); margin-right: 1rem;"></i>
                            <div>
                                <h4>Police</h4>
                                <p>100</p>
                            </div>
                            <button class="btn btn-danger ml-auto">
                                <i class="fas fa-phone"></i> Call
                            </button>
                        </div>
                        <div class="flex align-center">
                            <i class="fas fa-ambulance" style="font-size: 1.5rem; color: var(--danger-color); margin-right: 1rem;"></i>
                            <div>
                                <h4>Ambulance</h4>
                                <p>108</p>
                            </div>
                            <button class="btn btn-danger ml-auto">
                                <i class="fas fa-phone"></i> Call
                            </button>
                        </div>
                        <div class="flex align-center">
                            <i class="fas fa-fire-extinguisher" style="font-size: 1.5rem; color: var(--danger-color); margin-right: 1rem;"></i>
                            <div>
                                <h4>Fire Department</h4>
                                <p>101</p>
                            </div>
                            <button class="btn btn-danger ml-auto">
                                <i class="fas fa-phone"></i> Call
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Emergency Contacts Page -->
            <div id="emergencyContactsPage" class="page">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Emergency Contacts</h2>
                            <button class="btn btn-primary" id="addContactBtn">
                                <i class="fas fa-plus"></i> Add Contact
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <p>Manage your emergency contacts. These contacts will be notified when you trigger an SOS alert.</p>
                        </div>
                        
                        <div id="contactsList" class="grid">
                            <!-- Contacts will be dynamically loaded here -->
                        </div>
                        
                        <div class="text-center mt-3" id="emptyContactsMessage" style="display: none;">
                            <p>No emergency contacts added yet. Click "Add Contact" to get started.</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Emergency Settings</h3>
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Send SOS to all contacts</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="sosToAllToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                When enabled, SOS alerts will be sent to all your emergency contacts.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Include location in SOS</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="sosLocationToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Include your current location when sending SOS alerts.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-danger btn-block" id="testSosBtn">
                                <i class="fas fa-bell"></i> Test SOS Alert
                            </button>
                            <p class="mt-1 text-center" style="font-size: 0.9rem; color: #6c757d;">
                                Send a test SOS to your contacts (no actual emergency)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Purchase Page -->
            <div id="purchasePage" class="page">
                <div class="card">
                    <h3 class="card-title">Safety Products</h3>
                    <p>Enhance your safety with our range of products</p>
                </div>
                <div class="grid">
                    <div class="card product-card">
                        <img src="https://picsum.photos/seed/band/150/150.jpg" alt="Safety Band" class="product-image">
                        <h4 class="product-title">Safety Band - Basic</h4>
                        <p class="product-price">649</p>
                        <p>Mandated by government for basic safety features</p>
                        <button class="btn btn-primary btn-block mt-2">Purchase Now</button>
                    </div>
                    <div class="card product-card">
                        <img src="https://picsum.photos/seed/smartwatch/150/150.jpg" alt="Smartwatch Pro" class="product-image">
                        <h4 class="product-title">Smartwatch - Pro</h4>
                        <p class="product-price">1999</p>
                        <p>Advanced safety features with health monitoring</p>
                        <button class="btn btn-primary btn-block mt-2">Purchase Now</button>
                    </div>
                    <div class="card product-card">
                        <img src="https://picsum.photos/seed/advancedwatch/150/150.jpg" alt="Smartwatch Advanced" class="product-image">
                        <h4 class="product-title">Smartwatch - Advanced</h4>
                        <p class="product-price">6499</p>
                        <p>Premium safety features with GPS and fall detection</p>
                        <button class="btn btn-primary btn-block mt-2">Purchase Now</button>
                    </div>
                </div>
            </div>
            <!-- Settings Page -->
            <div id="settingsPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Settings</h2>
                    </div>
                    
                    <div class="form-group">
                        <h3>Profile</h3>
                        <div class="profile-preview">
                            <div class="profile-upload">
                                <img src="https://picsum.photos/seed/user123/150/150.jpg" alt="Profile" class="profile-img-large" id="settingsProfileImg">
                                <div class="upload-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="settingsProfileUpload" accept="image/*">
                            </div>
                            <p class="mt-2">Click on your profile picture to change it</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <h3>Appearance</h3>
                        <div class="flex align-center">
                            <span>Dark Mode</span>
                            <label class="toggle-switch ml-auto">
                                <input type="checkbox" id="darkModeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex align-center mt-2">
                            <span>High Contrast Mode</span>
                            <label class="toggle-switch ml-auto">
                                <input type="checkbox" id="highContrastToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <h3>Voice Assistant</h3>
                        <div class="flex align-center">
                            <span>Enable Voice Commands</span>
                            <label class="toggle-switch ml-auto">
                                <input type="checkbox" id="voiceAssistantToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p class="mt-2" style="font-size: 0.9rem; color: #6c757d;">
                            <i class="fas fa-info-circle"></i> 
                            Use voice commands to quickly access safety features and emergency contacts.
                        </p>
                    </div>
                    
                    <!-- Proactive SOS Settings -->
                    <div class="form-group">
                        <h3>Proactive SOS (AI/ML Powered)</h3>
                        <div class="flex align-center">
                            <span>Enable Proactive SOS</span>
                            <label class="toggle-switch ml-auto">
                                <input type="checkbox" id="proactiveSosToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                            Automatically detect emergencies using AI/ML and trigger SOS if needed
                        </p>
                    </div>
                    
                    <div id="proactiveSosSettings" class="hidden">
                        <div class="form-group">
                            <label for="sensitivitySlider">Sensitivity Level</label>
                            <input type="range" class="form-control" id="sensitivitySlider" min="1" max="3" value="2">
                            <div class="flex justify-between mt-1">
                                <span>Low</span>
                                <span>Medium</span>
                                <span>High</span>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Higher sensitivity may trigger more false alarms
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Use Microphone for Distress Detection</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="microphoneForDistressToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Listen for words like "help", "save me", etc.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Fall Detection</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="fallDetectionToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Detect sudden falls using motion sensors
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Unusual Movement Detection</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="movementDetectionToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Detect abnormal movement patterns
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-primary btn-block" id="testProactiveSosBtn">Test Proactive SOS</button>
                            <p class="mt-1 text-center" style="font-size: 0.9rem; color: #6c757d;">
                                Simulate an emergency to test the system
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <h4>How It Works</h4>
                            <div class="card" style="background-color: #f8f9fa; padding: 1rem; margin-top: 0.5rem;">
                                <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>1. Data Collection:</strong> Our system continuously gathers data from motion sensors, microphone (optional), and location services.</p>
                                <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>2. AI/ML Processing:</strong> Advanced algorithms analyze patterns to detect anomalies that may indicate an emergency.</p>
                                <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>3. Smart Verification:</strong> If a potential emergency is detected, the system will ask for verification before triggering SOS.</p>
                                <p style="font-size: 0.9rem;"><strong>4. Continuous Learning:</strong> The system adapts to your behavior patterns over time, reducing false alarms.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h3>Multi-Factor Authentication</h3>
                        <div class="flex align-center">
                            <span>Enable MFA</span>
                            <label class="toggle-switch ml-auto">
                                <input type="checkbox" id="mfaEnabledToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                            Add an extra layer of security to your account
                        </p>
                        
                        <div id="mfaSettings" class="mfa-settings hidden">
                            <div class="mfa-section">
                                <h4 class="mfa-section-title">Verification Methods</h4>
                                <div class="mfa-method">
                                    <i class="fas fa-envelope mfa-method-icon"></i>
                                    <div class="mfa-method-info">
                                        <div class="mfa-method-name">Email Verification</div>
                                        <div class="mfa-method-desc">Send a verification code to your email</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mfaEmailEnabled" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="mfa-method">
                                    <i class="fas fa-sms mfa-method-icon"></i>
                                    <div class="mfa-method-info">
                                        <div class="mfa-method-name">SMS Verification</div>
                                        <div class="mfa-method-desc">Send a verification code to your phone</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mfaSmsEnabled">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="mfa-method">
                                    <i class="fas fa-mobile-alt mfa-method-icon"></i>
                                    <div class="mfa-method-info">
                                        <div class="mfa-method-name">Authenticator App</div>
                                        <div class="mfa-method-desc">Use your authenticator app to generate a code</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mfaAuthenticatorEnabled">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mfa-section">
                                <h4 class="mfa-section-title">Require MFA For</h4>
                                <div class="flex align-center mb-2">
                                    <span>SOS Alerts</span>
                                    <label class="toggle-switch ml-auto">
                                        <input type="checkbox" id="mfaForSos" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="flex align-center mb-2">
                                    <span>Changing Password</span>
                                    <label class="toggle-switch ml-auto">
                                        <input type="checkbox" id="mfaForPassword" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="flex align-center mb-2">
                                    <span>Emergency Contacts</span>
                                    <label class="toggle-switch ml-auto">
                                        <input type="checkbox" id="mfaForContacts" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="flex align-center mb-2">
                                    <span>Government Login</span>
                                    <label class="toggle-switch ml-auto">
                                        <input type="checkbox" id="mfaForGovLogin" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary btn-block" id="setupMfaBtn">Setup MFA</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <h3>Language</h3>
                        <p>Select your preferred language</p>
                        <div class="language-selector">
                            <div class="language-option selected">English</div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                            <div class="language-option"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <h3>Account</h3>
                        <button class="btn btn-primary mb-2" id="changePasswordBtn">Change Password</button>
                        <button class="btn btn-primary mb-2">Multi-Verification Authorization</button>
                        <button class="btn btn-primary mb-2" id="emergencyContactsBtn">Emergency Contacts</button>
                        <button class="btn btn-primary mb-2" id="devicePermissionsBtn">Device Permissions</button>
                        <button class="btn btn-primary mb-2" id="linkedDevicesBtn">Linked Devices</button>
                        <button class="btn btn-primary mb-2" id="dataUsageBtn">Data Usage</button>
                        <button class="btn btn-primary mb-2" id="cookiePreferencesBtn">Cookie Preferences</button>
                        <button class="btn btn-primary mb-2" id="adChoicesBtn">Ad Choices</button>
                        <button class="btn btn-primary mb-2">Location Sharing</button>
                    </div>
                    <div class="form-group">
                        <h3>Storage</h3>
                        <button class="btn btn-primary mb-2">Cloud Storage</button>
                        <button class="btn btn-primary mb-2">Downloaded Maps</button>
                    </div>
                    <div class="form-group">
                        <h3>Support</h3>
                        <button class="btn btn-primary mb-2">Help</button>
                        <button class="btn btn-primary mb-2">Privacy and Policy</button>
                        <button class="btn btn-primary mb-2">About</button>
                    </div>
                    <div class="form-group">
                        <h3>Government Access</h3>
                        <button class="btn btn-gov mb-2" id="govLoginBtn">Government Login</button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-danger" id="logoutBtn">Log Out</button>
                    </div>
                </div>
            </div>
            
            <!-- Device Permissions Page -->
            <div id="devicePermissionsPage" class="page">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Device Permissions</h2>
                            <button class="btn btn-primary btn-sm" id="requestAllPermissionsBtn">
                                <i class="fas fa-check-circle"></i> Grant All
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <p>Manage permissions for Safety App features. Some permissions are required for full functionality.</p>
                        </div>
                        
                        <div class="permissions-list">
                            <!-- Location Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-map-marker-alt permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Location</h4>
                                            <p>Used for maps, safety zones, and emergency alerts</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="locationPermission" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to access your device's location to show your position on maps, identify safe zones, and send location information during emergencies.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator"></span>
                                        <span>Granted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Camera Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-camera permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Camera</h4>
                                            <p>Used for reporting incidents and profile pictures</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="cameraPermission" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to access your camera to take photos for incident reports, evidence collection, and profile pictures.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator"></span>
                                        <span>Granted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Microphone Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-microphone permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Microphone</h4>
                                            <p>Used for voice assistant and audio evidence</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="microphonePermission" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to access your microphone for voice commands, audio evidence recording during incidents, and voice assistant functionality.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator"></span>
                                        <span>Granted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contacts Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-address-book permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Contacts</h4>
                                            <p>Used for emergency contacts and sharing</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="contactsPermission" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to access your contacts to help you set up emergency contacts and share information during emergencies.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator"></span>
                                        <span>Granted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Storage Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-folder permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Storage</h4>
                                            <p>Used for saving maps, evidence, and offline content</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="storagePermission" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to store maps, evidence files, and other content on your device for offline access.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator"></span>
                                        <span>Granted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notifications Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-bell permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Notifications</h4>
                                            <p>Used for alerts and safety updates</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notificationsPermission" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to send you notifications about safety alerts, emergency updates, and other important information.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator"></span>
                                        <span>Granted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bluetooth Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-bluetooth-b permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Bluetooth</h4>
                                            <p>Used for connecting safety devices</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="bluetoothPermission">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to connect to Bluetooth devices such as safety bands, smartwatches, and other accessories.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator inactive"></span>
                                        <span>Not Granted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Phone Permission -->
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-phone permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Phone</h4>
                                            <p>Used for emergency calls and identification</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="phonePermission" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>This permission allows the app to make emergency calls and identify your device for safety purposes.</p>
                                    <div class="permission-status">
                                        <span class="status-indicator"></span>
                                        <span>Granted</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Linked Devices Page -->
            <div id="linkedDevicesPage" class="page">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Linked Devices</h2>
                            <button class="btn btn-primary btn-sm" id="addDeviceBtn">
                                <i class="fas fa-plus"></i> Add Device
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <p>Manage devices linked to your Safety App account. These devices can access your safety features and emergency contacts.</p>
                        </div>
                        
                        <div id="devicesList" class="grid">
                            <!-- Devices will be dynamically loaded here -->
                        </div>
                        
                        <div class="text-center mt-3" id="emptyDevicesMessage" style="display: none;">
                            <p>No devices linked yet. Click "Add Device" to get started.</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Device Security</h3>
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Require verification for new devices</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="deviceVerificationToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                When enabled, you'll need to verify your identity before linking a new device.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Notify me about new device logins</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="deviceNotificationToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Receive notifications when a new device logs into your account.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-danger btn-block" id="logoutAllDevicesBtn">
                                <i class="fas fa-sign-out-alt"></i> Log Out All Devices
                            </button>
                            <p class="mt-1 text-center" style="font-size: 0.9rem; color: #6c757d;">
                                This will log out all devices except the current one.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Usage Page -->
            <div id="dataUsagePage" class="page">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Data Usage</h2>
                            <button class="btn btn-primary btn-sm" id="refreshDataUsageBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <p>Monitor and manage your data usage for the Safety App.</p>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Current Usage</h3>
                        <div class="data-usage-summary">
                            <div>
                                <h4>This Month</h4>
                                <p id="currentDataUsage">245 MB</p>
                            </div>
                            <div>
                                <h4>Daily Average</h4>
                                <p id="dailyAverage">8.2 MB</p>
                            </div>
                            <div>
                                <h4>Remaining</h4>
                                <p id="dataRemaining">755 MB</p>
                            </div>
                        </div>
                        <div class="data-usage-progress">
                            <div class="data-usage-progress-bar" id="dataUsageProgressBar" style="width: 24.5%;"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Data Usage Over Time</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="dataUsageChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Usage by Feature</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="dataUsageBreakdownChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Feature Usage Details</h3>
                        <div class="data-usage-feature">
                            <div class="data-usage-feature-icon">
                                <i class="fas fa-map-marked-alt" style="color: var(--primary-color);"></i>
                            </div>
                            <div class="data-usage-feature-info">
                                <div class="data-usage-feature-name">Maps</div>
                                <div class="data-usage-feature-usage">Map tiles, location services</div>
                            </div>
                            <div class="data-usage-feature-value">120 MB</div>
                        </div>
                        <div class="data-usage-feature">
                            <div class="data-usage-feature-icon">
                                <i class="fas fa-bell" style="color: var(--danger-color);"></i>
                            </div>
                            <div class="data-usage-feature-info">
                                <div class="data-usage-feature-name">Notifications</div>
                                <div class="data-usage-feature-usage">Push notifications, alerts</div>
                            </div>
                            <div class="data-usage-feature-value">45 MB</div>
                        </div>
                        <div class="data-usage-feature">
                            <div class="data-usage-feature-icon">
                                <i class="fas fa-phone-alt" style="color: var(--success-color);"></i>
                            </div>
                            <div class="data-usage-feature-info">
                                <div class="data-usage-feature-name">Emergency Services</div>
                                <div class="data-usage-feature-usage">SOS alerts, emergency contacts</div>
                            </div>
                            <div class="data-usage-feature-value">35 MB</div>
                        </div>
                        <div class="data-usage-feature">
                            <div class="data-usage-feature-icon">
                                <i class="fas fa-sync" style="color: var(--warning-color);"></i>
                            </div>
                            <div class="data-usage-feature-info">
                                <div class="data-usage-feature-name">Profile Sync</div>
                                <div class="data-usage-feature-usage">Cloud backup, profile data</div>
                            </div>
                            <div class="data-usage-feature-value">25 MB</div>
                        </div>
                        <div class="data-usage-feature">
                            <div class="data-usage-feature-icon">
                                <i class="fas fa-ellipsis-h" style="color: var(--secondary-color);"></i>
                            </div>
                            <div class="data-usage-feature-info">
                                <div class="data-usage-feature-name">Other</div>
                                <div class="data-usage-feature-usage">App resources, analytics</div>
                            </div>
                            <div class="data-usage-feature-value">20 MB</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Data Usage Settings</h3>
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Set Data Limit</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="dataLimitToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="mt-2" id="dataLimitSettings" style="display: none;">
                                <div class="flex align-center">
                                    <input type="number" class="form-control" id="dataLimitValue" value="1000" min="100" max="10000" step="100" style="width: 120px;">
                                    <span class="ml-2">MB per month</span>
                                </div>
                                <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                    You'll receive a notification when you reach 80% of your limit.
                                </p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Reduce Data Usage</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="reduceDataUsageToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Lower image quality and reduce background updates to save data.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Background Data</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="backgroundDataToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Allow app to use data in the background for safety alerts and updates.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <div class="flex align-center">
                                <span>Auto-download Maps</span>
                                <label class="toggle-switch ml-auto">
                                    <input type="checkbox" id="autoDownloadMapsToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                                Automatically download map updates when on Wi-Fi.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-danger" id="resetDataUsageBtn">Reset Statistics</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Data Saving Tips</h3>
                        <div class="grid">
                            <div class="tip-card">
                                <i class="fas fa-map-marked-alt"></i>
                                <h4>Download Maps</h4>
                                <p>Download maps for offline use to save mobile data</p>
                            </div>
                            <div class="tip-card">
                                <i class="fas fa-image"></i>
                                <h4>Lower Image Quality</h4>
                                <p>Reduce image quality in settings to save data</p>
                            </div>
                            <div class="tip-card">
                                <i class="fas fa-wifi"></i>
                                <h4>Use Wi-Fi</h4>
                                <p>Use Wi-Fi for large downloads and updates</p>
                            </div>
                            <div class="tip-card">
                                <i class="fas fa-bell-slash"></i>
                                <h4>Limit Notifications</h4>
                                <p>Reduce notification frequency to save data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cookie Preferences Page -->
            <div id="cookiePreferencesPage" class="page">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Cookie Preferences</h2>
                            <button class="btn btn-primary btn-sm" id="saveCookiePreferences">
                                <i class="fas fa-save"></i> Save Preferences
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <p>We use cookies to enhance your experience on our app. You can choose which types of cookies you accept below.</p>
                        </div>
                        
                        <div class="form-group">
                            <h3>Cookie Categories</h3>
                            
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-lock permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Essential Cookies</h4>
                                            <p>Required for the app to function properly</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="essentialCookies" checked disabled>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>These cookies are necessary for the app to function and cannot be switched off. They include cookies that remember your preferences and security settings.</p>
                                </div>
                            </div>
                            
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-chart-bar permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Analytics Cookies</h4>
                                            <p>Help us understand how you use our app</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="analyticsCookies">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>These cookies allow us to count visits and traffic sources so we can measure and improve the performance of our app. They help us know which pages are the most and least popular.</p>
                                </div>
                            </div>
                            
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-ad permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Marketing Cookies</h4>
                                            <p>Used for advertising and personalization</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="marketingCookies">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>These cookies may be set through our site by our advertising partners. They may be used to build a profile of your interests and show you relevant adverts on other sites.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ad Choices Page -->
            <div id="adChoicesPage" class="page">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Ad Choices</h2>
                            <button class="btn btn-primary btn-sm" id="resetAdPreferencesBtn">
                                <i class="fas fa-undo"></i> Reset to Default
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <p>Manage your advertising preferences and control how ads are displayed in the Safety App.</p>
                        </div>
                        
                        <div class="form-group">
                            <h3>Ad Personalization</h3>
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-user-circle permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Personalized Ads</h4>
                                            <p>Show ads based on your interests and app usage</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="personalizedAdsToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>When enabled, you'll see ads that are more relevant to you based on your activity in the app and your interests.</p>
                                </div>
                            </div>
                            
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-map-marker-alt permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Location-Based Ads</h4>
                                            <p>Show ads relevant to your current location</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="locationBasedAdsToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>Allow advertisers to show you ads based on your geographic location. This can help you find local safety products and services.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <h3>Ad Frequency</h3>
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-clock permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Reduce Ad Frequency</h4>
                                            <p>See fewer ads while using the app</p>
                                        </div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="reduceAdFrequencyToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-details">
                                    <p>When enabled, you'll see fewer ads during your app experience. This may affect the free features available in the app.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <h3>Ad Categories</h3>
                            <p>Select the types of ads you're interested in seeing:</p>
                            <div class="ad-category-grid">
                                <div class="ad-category-item">
                                    <input type="checkbox" id="adCategorySafety" class="mr-2" checked>
                                    <label for="adCategorySafety">Safety Products</label>
                                </div>
                                <div class="ad-category-item">
                                    <input type="checkbox" id="adCategoryHealth" class="mr-2" checked>
                                    <label for="adCategoryHealth">Health & Wellness</label>
                                </div>
                                <div class="ad-category-item">
                                    <input type="checkbox" id="adCategoryTravel" class="mr-2">
                                    <label for="adCategoryTravel">Travel & Tourism</label>
                                </div>
                                <div class="ad-category-item">
                                    <input type="checkbox" id="adCategoryTechnology" class="mr-2">
                                    <label for="adCategoryTechnology">Technology</label>
                                </div>
                                <div class="ad-category-item">
                                    <input type="checkbox" id="adCategoryEducation" class="mr-2">
                                    <label for="adCategoryEducation">Education</label>
                                </div>
                                <div class="ad-category-item">
                                    <input type="checkbox" id="adCategoryFinance" class="mr-2">
                                    <label for="adCategoryFinance">Finance</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <h3>Ad Transparency</h3>
                            <div class="permission-item">
                                <div class="permission-header">
                                    <div class="flex align-center">
                                        <i class="fas fa-info-circle permission-icon" style="color: var(--primary-color);"></i>
                                        <div>
                                            <h4>Ad Identifier</h4>
                                            <p>Your unique advertising identifier</p>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm" id="resetAdIdBtn">Reset ID</button>
                                </div>
                                <div class="permission-details">
                                    <p>This identifier is used to deliver relevant ads and measure ad effectiveness. Resetting it will make your previous ad preferences less effective.</p>
                                    <div class="ad-identifier-display">
                                        ID: <span id="adIdentifier">SAFETY-APP-7F8A9B2C4D5E6</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <h3>Ad History</h3>
                            <div class="card">
                                <div class="flex justify-between align-center mb-2">
                                    <p>View and manage your ad interaction history</p>
                                    <button class="btn btn-danger btn-sm" id="clearAdHistoryBtn">Clear History</button>
                                </div>
                                <div id="adHistoryContainer" style="max-height: 200px; overflow-y: auto;">
                                    <div class="ad-history-item">
                                        <i class="fas fa-shield-alt ad-history-icon"></i>
                                        <div class="ad-history-info">
                                            <div class="ad-history-title">Safety Band Pro</div>
                                            <div class="ad-history-time">Viewed 2 days ago</div>
                                        </div>
                                    </div>
                                    <div class="ad-history-item">
                                        <i class="fas fa-heartbeat ad-history-icon" style="color: var(--danger-color);"></i>
                                        <div class="ad-history-info">
                                            <div class="ad-history-title">Health Monitoring Service</div>
                                            <div class="ad-history-time">Viewed 5 days ago</div>
                                        </div>
                                    </div>
                                    <div class="ad-history-item">
                                        <i class="fas fa-map-marked-alt ad-history-icon" style="color: var(--success-color);"></i>
                                        <div class="ad-history-info">
                                            <div class="ad-history-title">Travel Safety Guide</div>
                                            <div class="ad-history-time">Viewed 1 week ago</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <h3>Why do you see ads?</h3>
                            <div class="card">
                                <p class="mb-2">The Safety App is free to use thanks to the support of our advertising partners. Ads help us:</p>
                                <ul class="ml-3">
                                    <li>Keep the app free for all users</li>
                                    <li>Fund development of new safety features</li>
                                    <li>Maintain our servers and infrastructure</li>
                                    <li>Provide 24/7 emergency support</li>
                                </ul>
                                <p class="mt-2">You can support us directly by purchasing our premium safety products, which will also reduce or eliminate ads.</p>
                                <button class="btn btn-primary btn-block mt-2">View Premium Products</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Government Dashboard Page -->
            <div id="govDashboardPage" class="page">
                <div class="gov-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="color: var(--danger-color);">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-value" id="activeIncidentsStat">24</div>
                            <div class="stat-label">Active Incidents</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: var(--success-color);">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value" id="resolvedTodayStat">142</div>
                            <div class="stat-label">Resolved Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: var(--warning-color);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value" id="activeUsersStat">1,284</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: var(--primary-color);">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="stat-value" id="highRiskAreasStat">18</div>
                            <div class="stat-label">High Risk Areas</div>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Real-time Incident Map</h3>
                                <div class="flex align-center">
                                    <select class="form-control" id="govMapFilter" style="width: auto;">
                                        <option value="all">All Incidents</option>
                                        <option value="theft">Theft</option>
                                        <option value="harassment">Harassment</option>
                                        <option value="accident">Accident</option>
                                        <option value="suspicious">Suspicious</option>
                                        <option value="anomaly">Anomaly Detection</option>
                                        <option value="geofence">Geofence Breach</option>
                                    </select>
                                    <button class="btn btn-primary btn-sm ml-2" id="govMapRefresh">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="map-container" style="height: 400px;">
                                <div id="govMap" style="height: 100%; width: 100%; border-radius: 8px;"></div>
                                <div class="map-controls">
                                    <button class="map-control-btn" id="govMapZoomIn" title="Zoom In">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="map-control-btn" id="govMapZoomOut" title="Zoom Out">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="map-control-btn" id="govMapHeatmap" title="Toggle Heatmap">
                                        <i class="fas fa-fire"></i>
                                    </button>
                                    <button class="map-control-btn" id="govMapClusters" title="Toggle Clusters">
                                        <i class="fas fa-th"></i>
                                    </button>
                                </div>
                                <div class="map-legend">
                                    <div class="legend-title">Legend</div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: var(--danger-color);"></div>
                                        <span>Active Incident</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: var(--warning-color);"></div>
                                        <span>Recent Incident</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: var(--success-color);"></div>
                                        <span>Safe Zone</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: var(--primary-color);"></div>
                                        <span>Police Unit</span>
                                    </div>
                                </div>
                                <div class="map-info-panel">
                                    <div class="info-title">Live Statistics</div>
                                    <div class="info-content">
                                        <p>Active: <span id="govActiveIncidents">24</span></p>
                                        <p>Responding: <span id="govResponding">8</span></p>
                                        <p>Resolved: <span id="govResolved">142</span></p>
                                        <p>Avg Response: <span id="govAvgResponse">5.2 min</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Incident Trends</h3>
                                <select class="form-control" style="width: auto;">
                                    <option>Last 7 days</option>
                                    <option>Last 30 days</option>
                                    <option>Last 90 days</option>
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="incidentChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Alert Dispatch System</h3>
                                <button class="btn btn-primary btn-sm">View All</button>
                            </div>
                            <div id="alertsContainer">
                                <div class="alert-item">
                                    <div class="alert-header">
                                        <div class="alert-title">Theft Reported</div>
                                        <div class="alert-time">5 min ago</div>
                                    </div>
                                    <div class="alert-location"><i class="fas fa-map-marker-alt"></i> Main Market, Sector 12</div>
                                    <div class="alert-actions">
                                        <button class="btn btn-danger btn-sm">Dispatch Police</button>
                                        <button class="btn btn-primary btn-sm">View Details</button>
                                    </div>
                                </div>
                                <div class="alert-item">
                                    <div class="alert-header">
                                        <div class="alert-title">Medical Emergency</div>
                                        <div class="alert-time">12 min ago</div>
                                    </div>
                                    <div class="alert-location"><i class="fas fa-map-marker-alt"></i> City Hospital, Near Bus Stand</div>
                                    <div class="alert-actions">
                                        <button class="btn btn-danger btn-sm">Dispatch Ambulance</button>
                                        <button class="btn btn-primary btn-sm">View Details</button>
                                    </div>
                                </div>
                                <div class="alert-item">
                                    <div class="alert-header">
                                        <div class="alert-title">Suspicious Activity</div>
                                        <div class="alert-time">25 min ago</div>
                                    </div>
                                    <div class="alert-location"><i class="fas fa-map-marker-alt"></i> Park Area, Sector 5</div>
                                    <div class="alert-actions">
                                        <button class="btn btn-danger btn-sm">Dispatch Patrol</button>
                                        <button class="btn btn-primary btn-sm">View Details</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Evidence Logging</h3>
                                <button class="btn btn-primary btn-sm" id="addEvidenceBtn">Add Evidence</button>
                            </div>
                            <div id="evidenceContainer">
                                <div class="flex align-center mb-2 p-2" style="background-color: #f8f9fa; border-radius: 8px;">
                                    <i class="fas fa-camera" style="font-size: 1.5rem; color: var(--primary-color); margin-right: 1rem;"></i>
                                    <div>
                                        <h4>Theft Incident #1234</h4>
                                        <p style="font-size: 0.9rem; color: #6c757d;">3 images, 1 video</p>
                                    </div>
                                    <button class="btn btn-primary btn-sm ml-auto">View</button>
                                </div>
                                <div class="flex align-center mb-2 p-2" style="background-color: #f8f9fa; border-radius: 8px;">
                                    <i class="fas fa-microphone" style="font-size: 1.5rem; color: var(--primary-color); margin-right: 1rem;"></i>
                                    <div>
                                        <h4>Harassment Report #5678</h4>
                                        <p style="font-size: 0.9rem; color: #6c757d;">2 audio recordings</p>
                                    </div>
                                    <button class="btn btn-primary btn-sm ml-auto">View</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">AI/ML Predictive Analytics</h3>
                            <button class="btn btn-primary btn-sm">Refresh Analysis</button>
                        </div>
                        <div class="grid">
                            <div class="prediction-card">
                                <div class="prediction-header">
                                    <div class="prediction-title">High Risk Area Prediction</div>
                                    <div class="prediction-confidence">87%</div>
                                </div>
                                <div class="prediction-details">
                                    <p><strong>Location:</strong> Sector 8, Near Railway Station</p>
                                    <p><strong>Predicted Risk:</strong> Theft & Harassment</p>
                                    <p><strong>Time Frame:</strong> Tonight 8PM - 11PM</p>
                                    <p><strong>Recommended Action:</strong> Increase patrol in the area</p>
                                </div>
                            </div>
                            <div class="prediction-card">
                                <div class="prediction-header">
                                    <div class="prediction-title">Anomalous Behavior Detected</div>
                                    <div class="prediction-confidence">72%</div>
                                </div>
                                <div class="prediction-details">
                                    <p><strong>User ID:</strong> USR-7845</p>
                                    <p><strong>Behavior:</strong> Erratic movement patterns</p>
                                    <p><strong>Location:</strong> Industrial Area, Sector 3</p>
                                    <p><strong>Recommended Action:</strong> Check on user wellbeing</p>
                                </div>
                            </div>
                            <div class="prediction-card">
                                <div class="prediction-header">
                                    <div class="prediction-title">Crowd Density Alert</div>
                                    <div class="prediction-confidence">92%</div>
                                </div>
                                <div class="prediction-details">
                                    <p><strong>Location:</strong> City Center Mall</p>
                                    <p><strong>Predicted Crowd:</strong> Above capacity</p>
                                    <p><strong>Time Frame:</strong> Weekend Afternoon</p>
                                    <p><strong>Recommended Action:</strong> Deploy additional security</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="predictionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Alert Log</h3>
                            <button class="btn btn-primary btn-sm" id="refreshAlertLogBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="alert-log-container" id="alertLogContainer">
                            <div class="alert-log-item">
                                <div>
                                    <span class="alert-log-type anomaly">ANOMALY</span>
                                    <span>Anomaly detected for user1: IsolationForest flagged this as an outlier, Unusually long stop detected</span>
                                </div>
                                <div class="alert-log-time">2023-06-15 14:30:25</div>
                            </div>
                            <div class="alert-log-item">
                                <div>
                                    <span class="alert-log-type geofence">GEOFENCE</span>
                                    <span>user2 is going out of geofence: City Center</span>
                                </div>
                                <div class="alert-log-time">2023-06-15 14:28:10</div>
                            </div>
                            <div class="alert-log-item">
                                <div>
                                    <span class="alert-log-type anomaly">ANOMALY</span>
                                    <span>Anomaly detected for user3: IsolationForest flagged this as an outlier</span>
                                </div>
                                <div class="alert-log-time">2023-06-15 14:25:45</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-danger" id="govLogoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tourist Registration Page -->
            <div id="touristPage" class="page">
                <div class="container">
                    <div class="card">
                        <h2 class="card-title">Tourist Registration</h2>
                        <p>Register your travel details to generate a unique QR code for enhanced safety during your visit.</p>
                    </div>
                    
                    <div class="card">
                        <div class="method-selection">
                            <h3>Registration Method</h3>
                            <div class="method-option">
                                <input type="radio" id="blockchainMethod" name="regMethod" value="blockchain" checked>
                                <div>
                                    <label for="blockchainMethod"><strong>Blockchain Registration (Recommended)</strong></label>
                                    <div class="method-description">
                                        Creates a tamper-proof record on the blockchain. Highest security for your data.
                                    </div>
                                </div>
                            </div>
                            <div class="method-option">
                                <input type="radio" id="simpleMethod" name="regMethod" value="simple">
                                <div>
                                    <label for="simpleMethod"><strong>Simple Registration</strong></label>
                                    <div class="method-description">
                                        Quick and easy registration with email verification. No wallet required.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Blockchain Registration Section -->
                        <div id="blockchainSection">
                            <div class="wallet-info">
                                <div>
                                    <i class="fas fa-shield-alt" style="font-size: 1.5rem; color: var(--primary-color); margin-right: 1rem;"></i>
                                    <span id="walletStatus">Not connected</span>
                                </div>
                                <span class="wallet-status" id="walletStatusIndicator"></span>
                            </div>
                            <button id="connectBtn" class="btn btn-primary btn-block mt-2">Connect Wallet for Secure Registration</button>
                            <p class="text-center mt-2" style="font-size: 0.9rem; color: #6c757d;">
                                <i class="fas fa-info-circle"></i> 
                                This creates a tamper-proof record of your registration. No cryptocurrency needed.
                            </p>
                        </div>
                        
                        <!-- Simple Registration Section -->
                        <div id="simpleSection" class="hidden">
                            <div class="form-group">
                                <label for="email">Email Address:</label>
                                <input type="email" class="form-control" id="email" placeholder="Enter your email" />
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number:</label>
                                <input type="tel" class="form-control" id="phone" placeholder="Enter your phone number" />
                            </div>
                            <p class="text-center mt-2" style="font-size: 0.9rem; color: #6c757d;">
                                <i class="fas fa-info-circle"></i> 
                                We'll send a verification code to confirm your identity.
                            </p>
                        </div>
                        
                        <!-- Common Registration Form -->
                        <form id="regForm" class="mt-3">
                            <div class="form-group">
                                <label for="name">Full Name:</label>
                                <input type="text" class="form-control" id="name" required />
                            </div>
                            <div class="form-group">
                                <label for="passport">Passport / Aadhaar Number:</label>
                                <input type="text" class="form-control" id="passport" required />
                            </div>
                            <div class="form-group">
                                <label for="emergencyContact">Emergency Contact:</label>
                                <input type="text" class="form-control" id="emergencyContact" required />
                            </div>
                            <div class="form-group">
                                <label for="tripStart">Trip Start Date:</label>
                                <input type="date" class="form-control" id="tripStart" required />
                            </div>
                            <div class="form-group">
                                <label for="tripEnd">Trip End Date:</label>
                                <input type="date" class="form-control" id="tripEnd" required />
                            </div>
                            <div class="form-group">
                                <label for="itinerary">Travel Itinerary:</label>
                                <textarea class="form-control" id="itinerary" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Register & Generate QR Code</button>
                        </form>
                        
                        <!-- QR Code Display -->
                        <div id="qrSection" class="hidden mt-4">
                            <h3>Your Tourist ID & QR Code</h3>
                            <div class="qr-container">
                                <canvas id="qrcode"></canvas>
                                <button id="downloadQR" class="btn btn-success mt-3">
                                    <i class="fas fa-download"></i> Download QR Code
                                </button>
                            </div>
                            <div class="qr-info">
                                <h4><i class="fas fa-info-circle"></i> About Your QR Code</h4>
                                <p>This unique QR code contains your tourist registration information and can be used for:</p>
                                <ul>
                                    <li>Identity verification by authorities</li>
                                    <li>Emergency contact access</li>
                                    <li>Travel itinerary verification</li>
                                    <li>Access to tourist services</li>
                                </ul>
                                <p>Please keep this QR code accessible during your trip. You can download it as an image or take a screenshot.</p>
                            </div>
                        </div>
                        
                        <div id="result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button class="sos-button" id="sosButton">
        <i class="fas fa-exclamation"></i>
    </button>
    <button class="voice-assistant-btn" id="voiceAssistantBtn">
        <i class="fas fa-microphone"></i>
    </button>
    <div class="voice-modal" id="voiceModal">
        <div class="voice-modal-header">
            <div class="voice-modal-title">Voice Assistant</div>
            <div class="voice-modal-close" id="voiceModalClose">&times;</div>
        </div>
        <div class="voice-modal-content" id="voiceModalContent">
            Click the microphone button and say a command like "Help", "Emergency", or "Show Map"
        </div>
    </div>
    <div class="bottom-nav">
        <div class="container">
            <div class="nav-items">
                <a href="#" class="nav-item active" data-page="homePage">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="#" class="nav-item" data-page="mapPage">
                    <i class="fas fa-map"></i>
                    <span>Map</span>
                </a>
                <a href="#" class="nav-item" data-page="emergencyPage">
                    <i class="fas fa-phone-alt"></i>
                    <span>Emergency</span>
                </a>
                <a href="#" class="nav-item" data-page="purchasePage">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Purchase</span>
                </a>
                <a href="#" class="nav-item" data-page="settingsPage">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-item" data-page="touristPage">
                    <i class="fas fa-passport"></i>
                    <span>Tourist</span>
                </a>
            </div>
        </div>
    </div>
    <!-- SOS Modal -->
    <div id="sosModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Emergency SOS</h2>
                <span class="close" id="closeSosModal">&times;</span>
            </div>
            <div class="text-center">
                <p>Press and hold to send SOS alert</p>
                <div class="countdown" id="sosCountdown">5</div>
                <button class="btn btn-danger btn-block" id="confirmSosBtn">Send SOS</button>
                <button class="btn btn-primary mt-2" id="cancelSosBtn">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Proactive SOS Modal -->
    <div id="proactiveSosVerificationModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Potential Emergency Detected</h2>
                <span class="close" id="closeProactiveSosModal">&times;</span>
            </div>
            <div class="text-center">
                <div class="mb-3">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning-color);"></i>
                </div>
                <p id="proactiveSosReason">Our system has detected a potential emergency based on unusual activity patterns.</p>
                <div class="mt-3 mb-3">
                    <div class="countdown" id="proactiveSosCountdown">10</div>
                    <p>If you're okay, please cancel below. Otherwise, SOS will be automatically triggered.</p>
                </div>
                <div class="flex justify-center gap-2">
                    <button class="btn btn-danger" id="confirmProactiveSosBtn">
                        <i class="fas fa-exclamation"></i> Trigger SOS Now
                    </button>
                    <button class="btn btn-primary" id="cancelProactiveSosBtn">I'm Okay</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Incident Report Modal -->
    <div id="incidentModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Report Incident</h2>
                <span class="close" id="closeIncidentModal">&times;</span>
            </div>
            <form>
                <div class="form-group">
                    <label for="incidentType">Incident Type</label>
                    <select class="form-control" id="incidentType" required>
                        <option value="">Select incident type</option>
                        <option value="theft">Theft</option>
                        <option value="harassment">Harassment</option>
                        <option value="accident">Accident</option>
                        <option value="suspicious">Suspicious Activity</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="incidentLocation">Location</label>
                    <input type="text" class="form-control" id="incidentLocation" placeholder="Enter location" required>
                </div>
                <div class="form-group">
                    <label for="incidentDescription">Description</label>
                    <textarea class="form-control" id="incidentDescription" rows="4" placeholder="Describe the incident" required></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Change Password Modal -->
    <div id="passwordModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Change Password</h2>
                <span class="close" id="closePasswordModal">&times;</span>
            </div>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" class="form-control" id="newPassword" placeholder="Enter new password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Change Password</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Government Login Modal -->
    <div id="govLoginModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Government Official Login</h2>
                <span class="close" id="closeGovLoginModal">&times;</span>
            </div>
            
            <!-- Demo Credentials Box -->
            <div class="demo-credentials">
                <div class="credentials-title">Demo Credentials</div>
                <div class="credentials-info">
                    <p><strong>Username:</strong> govadmin</p>
                    <p><strong>Password:</strong> gov123</p>
                    <p><strong>Department:</strong> Any department</p>
                </div>
            </div>
            
            <form id="govLoginForm">
                <div class="form-group">
                    <label for="govUsername">Username</label>
                    <input type="text" class="form-control" id="govUsername" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="govPassword">Password</label>
                    <input type="password" class="form-control" id="govPassword" placeholder="Enter password" required>
                </div>
                <div class="form-group">
                    <label for="govDepartment">Department</label>
                    <select class="form-control" id="govDepartment" required>
                        <option value="">Select department</option>
                        <option value="police">Police</option>
                        <option value="tourism">Tourism</option>
                        <option value="emergency">Emergency Services</option>
                        <option value="admin">Administration</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-gov btn-block">Login</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Evidence Modal -->
    <div id="evidenceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Evidence</h2>
                <span class="close" id="closeEvidenceModal">&times;</span>
            </div>
            <form id="evidenceForm">
                <div class="form-group">
                    <label for="evidenceIncident">Incident ID</label>
                    <input type="text" class="form-control" id="evidenceIncident" placeholder="Enter incident ID" required>
                </div>
                <div class="evidence-form">
                    <div class="form-group">
                        <label for="evidenceType">Evidence Type</label>
                        <select class="form-control" id="evidenceType" required>
                            <option value="">Select type</option>
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                            <option value="document">Document</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="evidenceFile">Upload File</label>
                        <input type="file" class="form-control" id="evidenceFile" required>
                    </div>
                    <div class="form-group">
                        <label for="evidenceDescription">Description</label>
                        <textarea class="form-control" id="evidenceDescription" rows="3" placeholder="Describe the evidence"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Submit Evidence</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Profile Picture Upload Modal -->
    <div id="profilePicModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Change Profile Picture</h2>
                <span class="close" id="closeProfilePicModal">&times;</span>
            </div>
            <div class="profile-preview">
                <img src="https://picsum.photos/seed/user123/150/150.jpg" alt="Profile Preview" class="profile-img-large" id="profilePreview">
            </div>
            <div class="form-group">
                <label for="profilePicInput">Select Image</label>
                <input type="file" class="form-control" id="profilePicInput" accept="image/*">
                <small class="text-muted">Supported formats: JPG, PNG, GIF. Max size: 5MB.</small>
            </div>
            <div class="crop-actions">
                <button class="btn btn-primary" id="saveProfilePic">Save Picture</button>
                <button class="btn btn-secondary" id="cancelProfilePic">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div id="contactModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="contactModalTitle">Add Emergency Contact</h2>
                <span class="close" id="closeContactModal">&times;</span>
            </div>
            <form id="contactForm">
                <input type="hidden" id="contactId">
                <div class="form-group">
                    <label for="contactName">Name *</label>
                    <input type="text" class="form-control" id="contactName" placeholder="Enter contact name" required>
                </div>
                <div class="form-group">
                    <label for="contactPhone">Phone Number *</label>
                    <input type="tel" class="form-control" id="contactPhone" placeholder="Enter phone number" required>
                </div>
                <div class="form-group">
                    <label for="contactRelationship">Relationship</label>
                    <input type="text" class="form-control" id="contactRelationship" placeholder="e.g., Spouse, Parent, Friend">
                </div>
                <div class="form-group">
                    <label for="contactEmail">Email</label>
                    <input type="email" class="form-control" id="contactEmail" placeholder="Enter email address">
                </div>
                <div class="form-group">
                    <div class="flex align-center">
                        <span>Set as Primary Contact</span>
                        <label class="toggle-switch ml-auto">
                            <input type="checkbox" id="contactPrimary">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                        Primary contact will be notified first in an emergency.
                    </p>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Save Contact</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- SOS Confirmation Modal -->
    <div id="sosConfirmationModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Send SOS Alert</h2>
                <span class="close" id="closeSosConfirmationModal">&times;</span>
            </div>
            <div class="text-center">
                <p>Are you sure you want to send an SOS alert to your emergency contacts?</p>
                <p id="sosContactsCount" class="mt-2 mb-3"></p>
                <div class="flex justify-center gap-2">
                    <button class="btn btn-danger" id="confirmSosAlertBtn">
                        <i class="fas fa-exclamation-triangle"></i> Send SOS
                    </button>
                    <button class="btn btn-primary" id="cancelSosAlertBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MFA Verification Modal -->
    <div id="mfaModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Verify Your Identity</h2>
                <span class="close" id="closeMfaModal">&times;</span>
            </div>
            <div class="text-center mb-3">
                <p>For security, please verify your identity to continue</p>
            </div>
            
            <div class="method-selection">
                <h3>Verification Method</h3>
                <div class="method-option">
                    <input type="radio" id="mfaEmail" name="mfaMethod" value="email" checked>
                    <div>
                        <label for="mfaEmail"><strong>Email Verification</strong></label>
                        <div class="method-description">
                            Send a verification code to your email
                        </div>
                    </div>
                </div>
                <div class="method-option">
                    <input type="radio" id="mfaSms" name="mfaMethod" value="sms">
                    <div>
                        <label for="mfaSms"><strong>SMS Verification</strong></label>
                        <div class="method-description">
                            Send a verification code to your phone
                        </div>
                    </div>
                </div>
                <div class="method-option">
                    <input type="radio" id="mfaAuthenticator" name="mfaMethod" value="authenticator">
                    <div>
                        <label for="mfaAuthenticator"><strong>Authenticator App</strong></label>
                        <div class="method-description">
                            Use your authenticator app to generate a code
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group mt-3">
                <label for="mfaCode">Verification Code</label>
                <input type="text" class="form-control mfa-code-input" id="mfaCode" placeholder="Enter verification code" maxlength="6">
                <div class="mfa-timer" id="mfaTimer">Code expires in: 5:00</div>
                <div class="mfa-resend">
                    <a href="#" id="resendMfaCode">Resend code</a>
                </div>
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary btn-block" id="verifyMfaBtn">Verify</button>
            </div>
            
            <div id="mfaStatus" class="text-center mt-2 hidden">
                <div class="loading-spinner"></div>
                <p>Verifying...</p>
            </div>
        </div>
    </div>
    
    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Device</h2>
                <span class="close" id="closeAddDeviceModal">&times;</span>
            </div>
            <form id="addDeviceForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" class="form-control" id="deviceName" placeholder="e.g., My iPhone, Home Tablet" required>
                </div>
                <div class="form-group">
                    <label for="deviceType">Device Type</label>
                    <select class="form-control" id="deviceType" required>
                        <option value="">Select device type</option>
                        <option value="smartphone">Smartphone</option>
                        <option value="tablet">Tablet</option>
                        <option value="laptop">Laptop</option>
                        <option value="smartwatch">Smartwatch</option>
                        <option value="safety-band">Safety Band</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deviceLocation">Device Location</label>
                    <input type="text" class="form-control" id="deviceLocation" placeholder="e.g., Home, Office, Car" required>
                </div>
                <div class="form-group">
                    <div class="flex align-center">
                        <span>Set as trusted device</span>
                        <label class="toggle-switch ml-auto">
                            <input type="checkbox" id="deviceTrustedToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p class="mt-1" style="font-size: 0.9rem; color: #6c757d;">
                        Trusted devices can bypass additional verification steps.
                    </p>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Add Device</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Cookie Preferences Modal -->
    <div id="cookieModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Cookie Preferences</h2>
                <span class="close" id="closeCookieModal">&times;</span>
            </div>
            <div class="mb-3">
                <p>We use cookies to enhance your experience on our app. You can choose which types of cookies you accept below.</p>
            </div>
            
            <div class="form-group">
                <h3>Cookie Categories</h3>
                
                <div class="permission-item">
                    <div class="permission-header">
                        <div class="flex align-center">
                            <i class="fas fa-lock permission-icon" style="color: var(--primary-color);"></i>
                            <div>
                                <h4>Essential Cookies</h4>
                                <p>Required for the app to function properly</p>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="essentialCookies" checked disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-details">
                        <p>These cookies are necessary for the app to function and cannot be switched off. They include cookies that remember your preferences and security settings.</p>
                    </div>
                </div>
                
                <div class="permission-item">
                    <div class="permission-header">
                        <div class="flex align-center">
                            <i class="fas fa-chart-bar permission-icon" style="color: var(--primary-color);"></i>
                            <div>
                                <h4>Analytics Cookies</h4>
                                <p>Help us understand how you use our app</p>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="analyticsCookies">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-details">
                        <p>These cookies allow us to count visits and traffic sources so we can measure and improve the performance of our app. They help us know which pages are the most and least popular.</p>
                    </div>
                </div>
                
                <div class="permission-item">
                    <div class="permission-header">
                        <div class="flex align-center">
                            <i class="fas fa-ad permission-icon" style="color: var(--primary-color);"></i>
                            <div>
                                <h4>Marketing Cookies</h4>
                                <p>Used for advertising and personalization</p>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="marketingCookies">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-details">
                        <p>These cookies may be set through our site by our advertising partners. They may be used to build a profile of your interests and show you relevant adverts on other sites.</p>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary btn-block" id="saveCookiePreferences">Save Preferences</button>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    <script>
        // API Configuration
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        // Global variables
        let userMap, govMap;
        let govMarkers = [];
        let heatmapLayer, clusterLayer;
        let alertPollingInterval = null;
        let web3Modal;
        let web3;
        let account;
        let contract;
        let voiceRecognition;
        let isListening = false;
        
        // Emergency Contacts Management
        let emergencyContacts = [];
        let editingContactId = null;
        
        // Notification System
        let notifications = [];
        let unreadCount = 0;
        
        // Device Permissions Management
        let devicePermissions = {
            location: true,
            camera: true,
            microphone: true,
            contacts: true,
            storage: true,
            notifications: true,
            bluetooth: false,
            phone: true
        };
        
        // MFA Variables
        let mfaEnabled = false;
        let mfaSettings = {
            email: true,
            sms: false,
            authenticator: false,
            forSos: true,
            forPassword: true,
            forContacts: true,
            forGovLogin: true
        };
        let mfaVerificationCallback = null;
        let mfaActionCode = null;
        let mfaTimerInterval = null;
        
        // Linked Devices Management
        let linkedDevices = [];
        let editingDeviceId = null;
        
        // Data Usage Variables
        let dataUsageChartInstance = null;
        let dataUsageBreakdownChartInstance = null;
        
        // Cookie Preferences Variables
        let cookiePreferences = {
            essential: true,
            analytics: false,
            marketing: false
        };
        
        // Ad Choices Variables
        let adPreferences = {
            personalizedAds: false,
            locationBasedAds: false,
            reduceAdFrequency: false,
            categories: {
                safety: true,
                health: true,
                travel: false,
                technology: false,
                education: false,
                finance: false
            },
            adIdentifier: 'SAFETY-APP-7F8A9B2C4D5E6'
        };
        
        // Proactive SOS System Variables
        let proactiveSosEnabled = false;
        let sensitivityLevel = 2; // 1: low, 2: medium, 3: high
        let microphoneForDistress = false;
        let fallDetectionEnabled = true;
        let movementDetectionEnabled = true;
        let proactiveSosInterval = null;
        let voiceRecognitionForDistress = null;
        let isListeningForDistress = false;
        let userBehaviorModel = {
            normalMovementPatterns: [],
            normalLocations: [],
            normalActivityTimes: [],
            lastCalibration: Date.now()
        };
        
        // Load saved profile picture on page load
        function loadProfilePicture() {
            const savedProfilePic = localStorage.getItem('userProfilePicture');
            if (savedProfilePic) {
                document.getElementById('homeProfileImg').src = savedProfilePic;
                document.getElementById('settingsProfileImg').src = savedProfilePic;
                document.getElementById('profilePreview').src = savedProfilePic;
            }
        }
        
        // Load saved device permissions
        function loadDevicePermissions() {
            const savedPermissions = localStorage.getItem('devicePermissions');
            if (savedPermissions) {
                devicePermissions = JSON.parse(savedPermissions);
                
                // Update UI
                Object.keys(devicePermissions).forEach(permission => {
                    const toggle = document.getElementById(`${permission}Permission`);
                    if (toggle) {
                        toggle.checked = devicePermissions[permission];
                        updatePermissionStatus(permission, devicePermissions[permission]);
                    }
                });
            }
        }
        
        // Save device permissions
        function saveDevicePermissions() {
            localStorage.setItem('devicePermissions', JSON.stringify(devicePermissions));
        }
        
        // Update permission status display
        function updatePermissionStatus(permission, granted) {
            const permissionItem = document.querySelector(`#${permission}Permission`).closest('.permission-item');
            const statusIndicator = permissionItem.querySelector('.status-indicator');
            const statusText = permissionItem.querySelector('.permission-status span:last-child');
            
            if (granted) {
                statusIndicator.classList.remove('inactive');
                statusText.textContent = 'Granted';
            } else {
                statusIndicator.classList.add('inactive');
                statusText.textContent = 'Not Granted';
            }
        }
        
        // Function to dynamically load scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Form validation function
        function validateForm(form) {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            return isValid;
        }
        
        // Safe map initialization
        function safeInitMap(mapId, initFunction) {
            const mapContainer = document.getElementById(mapId);
            if (!mapContainer) {
                console.error(`Map container ${mapId} not found`);
                return;
            }
            
            try {
                initFunction();
            } catch (error) {
                console.error(`Error initializing map ${mapId}:`, error);
                addNotification(`Failed to load map. Please try again.`, 'error');
            }
        }
        
        // Initialize User Map with proper cleanup
        function initUserMap() {
            // Check if map container exists
            const mapContainer = document.getElementById('userMap');
            if (!mapContainer) return;
            
            // Properly destroy existing map instance
            if (userMap) {
                userMap.remove();
                userMap = null;
            }
            
            try {
                userMap = L.map('userMap').setView([28.6139, 77.2090], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(userMap);
                
                // Add user location
                L.marker([28.6139, 77.2090], {
                    icon: L.divIcon({
                        className: 'user-location-marker',
                        html: '<div style="background-color: var(--primary-color); width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(userMap).bindPopup('Your current location');
                
                // Add safe zones
                L.circle([28.6239, 77.2190], {
                    color: 'var(--success-color)',
                    fillColor: 'rgba(76, 201, 240, 0.3)',
                    fillOpacity: 0.5,
                    radius: 500
                }).addTo(userMap).bindPopup('<b>Safe Zone</b><br>Police monitored area');
                
                L.circle([28.6039, 77.1990], {
                    color: 'var(--success-color)',
                    fillColor: 'rgba(76, 201, 240, 0.3)',
                    fillOpacity: 0.5,
                    radius: 400
                }).addTo(userMap).bindPopup('<b>Safe Zone</b><br>Well-lit public space');
                
                // Add risk zones
                L.circle([28.6339, 77.2290], {
                    color: 'var(--danger-color)',
                    fillColor: 'rgba(247, 37, 133, 0.3)',
                    fillOpacity: 0.5,
                    radius: 300
                }).addTo(userMap).bindPopup('<b>Risk Area</b><br>Reported incidents in this area');
                
                L.circle([28.5939, 77.1890], {
                    color: 'var(--danger-color)',
                    fillColor: 'rgba(247, 37, 133, 0.3)',
                    fillOpacity: 0.5,
                    radius: 350
                }).addTo(userMap).bindPopup('<b>Risk Area</b><br>Avoid after dark');
                
                // Add incident markers
                const incident1 = L.marker([28.6189, 77.2140], {
                    icon: L.divIcon({
                        className: 'incident-marker',
                        html: '<div style="background-color: var(--warning-color); width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                }).addTo(userMap);
                
                const incident2 = L.marker([28.6089, 77.2040], {
                    icon: L.divIcon({
                        className: 'incident-marker',
                        html: '<div style="background-color: var(--warning-color); width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                }).addTo(userMap);
                
                const incident3 = L.marker([28.6289, 77.2240], {
                    icon: L.divIcon({
                        className: 'incident-marker',
                        html: '<div style="background-color: var(--warning-color); width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                }).addTo(userMap);
                
                // Add popups for incidents
                incident1.bindPopup(`
                    <div class="incident-popup">
                        <div class="popup-title">Theft Reported</div>
                        <div class="popup-details"><i class="fas fa-map-marker-alt"></i> Main Market, Sector 12</div>
                        <div class="popup-details"><i class="fas fa-clock"></i> 2 hours ago</div>
                        <div class="popup-actions">
                            <button class="popup-btn btn-danger">Report</button>
                            <button class="popup-btn btn-primary">Details</button>
                        </div>
                    </div>
                `);
                
                incident2.bindPopup(`
                    <div class="incident-popup">
                        <div class="popup-title">Suspicious Activity</div>
                        <div class="popup-details"><i class="fas fa-map-marker-alt"></i> Park Area, Sector 5</div>
                        <div class="popup-details"><i class="fas fa-clock"></i> 5 hours ago</div>
                        <div class="popup-actions">
                            <button class="popup-btn btn-danger">Report</button>
                            <button class="popup-btn btn-primary">Details</button>
                        </div>
                    </div>
                `);
                
                incident3.bindPopup(`
                    <div class="incident-popup">
                        <div class="popup-title">Harassment Incident</div>
                        <div class="popup-details"><i class="fas fa-map-marker-alt"></i> Bus Stand, Sector 8</div>
                        <div class="popup-details"><i class="fas fa-clock"></i> 1 day ago</div>
                        <div class="popup-actions">
                            <button class="popup-btn btn-danger">Report</button>
                            <button class="popup-btn btn-primary">Details</button>
                        </div>
                    </div>
                `);
                
                // Update map info
                updateMapInfo(userMap);
                
                // Map controls
                document.getElementById('userMapZoomIn').addEventListener('click', function() {
                    userMap.zoomIn();
                });
                
                document.getElementById('userMapZoomOut').addEventListener('click', function() {
                    userMap.zoomOut();
                });
                
                document.getElementById('userMapLocate').addEventListener('click', function() {
                    userMap.setView([28.6139, 77.2090], 15);
                });
                
                document.getElementById('userMapFullscreen').addEventListener('click', function() {
                    const mapContainer = document.querySelector('#mapPage .map-container');
                    if (mapContainer.requestFullscreen) {
                        mapContainer.requestFullscreen();
                    } else if (mapContainer.webkitRequestFullscreen) {
                        mapContainer.webkitRequestFullscreen();
                    } else if (mapContainer.msRequestFullscreen) {
                        mapContainer.msRequestFullscreen();
                    }
                });
                
                // Map layer change
                document.getElementById('mapLayerSelect').addEventListener('change', function() {
                    const layer = this.value;
                    let tileLayer;
                    
                    switch(layer) {
                        case 'satellite':
                            tileLayer = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                            break;
                        case 'terrain':
                            tileLayer = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
                            break;
                        default:
                            tileLayer = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                    }
                    
                    userMap.eachLayer(function(layer) {
                        if (layer instanceof L.TileLayer) {
                            userMap.removeLayer(layer);
                        }
                    });
                    
                    L.tileLayer(tileLayer, {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(userMap);
                });
                
                // Refresh map
                document.getElementById('refreshMapBtn').addEventListener('click', function() {
                    document.getElementById('mapLoading').classList.remove('hidden');
                    
                    // Simulate loading
                    setTimeout(function() {
                        document.getElementById('mapLoading').classList.add('hidden');
                        addNotification('Map refreshed successfully', 'success');
                    }, 1000);
                });
                
                // Map events
                userMap.on('zoomend', function() {
                    updateMapInfo(userMap);
                });
                
                userMap.on('moveend', function() {
                    updateMapInfo(userMap);
                });
                
            } catch (error) {
                console.error('Error initializing user map:', error);
                addNotification('Failed to load map. Please try again.', 'error');
            }
        }
        
        // Initialize Government Map with proper cleanup
        function initGovMap() {
            // Check if map container exists
            const mapContainer = document.getElementById('govMap');
            if (!mapContainer) return;
            
            // Properly destroy existing map instance
            if (govMap) {
                govMap.remove();
                govMap = null;
            }
            
            try {
                govMap = L.map('govMap').setView([28.6139, 77.2090], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(govMap);
                
                // Clear existing markers
                govMarkers.forEach(marker => govMap.removeLayer(marker));
                govMarkers = [];
                
                // Add safe zones
                L.circle([28.6239, 77.2190], {
                    color: 'var(--success-color)',
                    fillColor: 'rgba(76, 201, 240, 0.3)',
                    fillOpacity: 0.5,
                    radius: 500
                }).addTo(govMap).bindPopup('<b>Safe Zone</b><br>Police monitored area');
                
                L.circle([28.6039, 77.1990], {
                    color: 'var(--success-color)',
                    fillColor: 'rgba(76, 201, 240, 0.3)',
                    fillOpacity: 0.5,
                    radius: 400
                }).addTo(govMap).bindPopup('<b>Safe Zone</b><br>Well-lit public space');
                
                // Add risk zones
                L.circle([28.6339, 77.2290], {
                    color: 'var(--danger-color)',
                    fillColor: 'rgba(247, 37, 133, 0.3)',
                    fillOpacity: 0.5,
                    radius: 300
                }).addTo(govMap).bindPopup('<b>Risk Area</b><br>High incident rate');
                
                L.circle([28.5939, 77.1890], {
                    color: 'var(--danger-color)',
                    fillColor: 'rgba(247, 37, 133, 0.3)',
                    fillOpacity: 0.5,
                    radius: 350
                }).addTo(govMap).bindPopup('<b>Risk Area</b><br>Avoid after dark');
                
                // Add incident markers
                const incidents = [
                    { lat: 28.6189, lng: 77.2140, type: 'theft', time: '5 min ago', location: 'Main Market, Sector 12' },
                    { lat: 28.6089, lng: 77.2040, type: 'medical', time: '12 min ago', location: 'City Hospital, Near Bus Stand' },
                    { lat: 28.6289, lng: 77.2240, type: 'suspicious', time: '25 min ago', location: 'Park Area, Sector 5' },
                    { lat: 28.6159, lng: 77.2150, type: 'harassment', time: '1 hour ago', location: 'Shopping Mall, Sector 10' },
                    { lat: 28.6259, lng: 77.2250, type: 'accident', time: '2 hours ago', location: 'Highway, Sector 15' }
                ];
                
                incidents.forEach(incident => {
                    const color = incident.type === 'theft' || incident.type === 'harassment' ? 'var(--danger-color)' : 'var(--warning-color)';
                    const marker = L.marker([incident.lat, incident.lng], {
                        icon: L.divIcon({
                            className: 'incident-marker',
                            html: `<div style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; animation: pulse 2s infinite;"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(govMap);
                    
                    marker.bindPopup(`
                        <div class="incident-popup">
                            <div class="popup-title">${incident.type.charAt(0).toUpperCase() + incident.type.slice(1)} Reported</div>
                            <div class="popup-details"><i class="fas fa-map-marker-alt"></i> ${incident.location}</div>
                            <div class="popup-details"><i class="fas fa-clock"></i> ${incident.time}</div>
                            <div class="popup-actions">
                                <button class="popup-btn btn-danger">Dispatch</button>
                                <button class="popup-btn btn-primary">Details</button>
                            </div>
                        </div>
                    `);
                    
                    govMarkers.push(marker);
                });
                
                // Add police unit markers
                const policeUnits = [
                    { lat: 28.6200, lng: 77.2100, id: 'PU-001' },
                    { lat: 28.6100, lng: 77.2000, id: 'PU-002' },
                    { lat: 28.6300, lng: 77.2200, id: 'PU-003' }
                ];
                
                policeUnits.forEach(unit => {
                    const marker = L.marker([unit.lat, unit.lng], {
                        icon: L.divIcon({
                            className: 'police-marker',
                            html: `<div style="background-color: var(--primary-color); width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">P</div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(govMap);
                    
                    marker.bindPopup(`<b>Police Unit ${unit.id}</b><br>On patrol`);
                    govMarkers.push(marker);
                });
                
                // Map controls
                document.getElementById('govMapZoomIn').addEventListener('click', function() {
                    govMap.zoomIn();
                });
                
                document.getElementById('govMapZoomOut').addEventListener('click', function() {
                    govMap.zoomOut();
                });
                
                document.getElementById('govMapHeatmap').addEventListener('click', function() {
                    // Toggle heatmap (simulated)
                    addNotification('Heatmap view toggled', 'info');
                });
                
                document.getElementById('govMapClusters').addEventListener('click', function() {
                    // Toggle clusters (simulated)
                    addNotification('Cluster view toggled', 'info');
                });
                
                // Map filter
                document.getElementById('govMapFilter').addEventListener('change', function() {
                    const filter = this.value;
                    addNotification(`Filtering by: ${filter}`, 'info');
                });
                
                // Refresh map
                document.getElementById('govMapRefresh').addEventListener('click', function() {
                    addNotification('Map refreshed with latest incidents', 'success');
                    // In a real app, this would fetch new data
                });
                
                // Simulate real-time updates
                setInterval(function() {
                    // Update statistics
                    document.getElementById('govActiveIncidents').textContent = Math.floor(Math.random() * 10) + 20;
                    document.getElementById('govResponding').textContent = Math.floor(Math.random() * 5) + 5;
                    document.getElementById('govResolved').textContent = Math.floor(Math.random() * 20) + 130;
                    document.getElementById('govAvgResponse').textContent = (Math.random() * 2 + 4).toFixed(1) + ' min';
                    
                    // Update stats in cards
                    document.getElementById('activeIncidentsStat').textContent = document.getElementById('govActiveIncidents').textContent;
                    document.getElementById('resolvedTodayStat').textContent = document.getElementById('govResolved').textContent;
                }, 5000);
                
            } catch (error) {
                console.error('Error initializing government map:', error);
                addNotification('Failed to load map. Please try again.', 'error');
            }
        }
        
        // Update map information
        function updateMapInfo(map) {
            const zoom = map.getZoom();
            const center = map.getCenter();
            
            document.getElementById('mapZoomLevel').textContent = zoom;
            document.getElementById('mapCenter').textContent = `${center.lat.toFixed(4)} ${center.lat > 0 ? 'N' : 'S'}, ${center.lng.toFixed(4)} ${center.lng > 0 ? 'E' : 'W'}`;
            document.getElementById('mapIncidentCount').textContent = '3';
        }
        
        // Initialize Charts with proper cleanup
        function initCharts() {
            try {
                // Destroy existing chart instances if they exist
                if (window.incidentChartInstance) {
                    window.incidentChartInstance.destroy();
                    window.incidentChartInstance = null;
                }
                
                if (window.predictionChartInstance) {
                    window.predictionChartInstance.destroy();
                    window.predictionChartInstance = null;
                }
                
                // Incident Trends Chart
                const incidentCtx = document.getElementById('incidentChart');
                if (incidentCtx) {
                    window.incidentChartInstance = new Chart(incidentCtx, {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Theft',
                                data: [12, 19, 8, 15, 22, 13, 16],
                                borderColor: '#f72585',
                                backgroundColor: 'rgba(247, 37, 133, 0.1)',
                                tension: 0.4
                            }, {
                                label: 'Harassment',
                                data: [7, 11, 5, 8, 12, 9, 6],
                                borderColor: '#4361ee',
                                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                                tension: 0.4
                            }, {
                                label: 'Accidents',
                                data: [3, 5, 2, 4, 6, 3, 4],
                                borderColor: '#f8961e',
                                backgroundColor: 'rgba(248, 150, 30, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                
                // Prediction Chart
                const predictionCtx = document.getElementById('predictionChart');
                if (predictionCtx) {
                    window.predictionChartInstance = new Chart(predictionCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Sector 1', 'Sector 2', 'Sector 3', 'Sector 4', 'Sector 5', 'Sector 6'],
                            datasets: [{
                                label: 'Risk Level',
                                data: [65, 42, 78, 35, 89, 56],
                                backgroundColor: [
                                    'rgba(67, 97, 238, 0.7)',
                                    'rgba(67, 97, 238, 0.7)',
                                    'rgba(247, 37, 133, 0.7)',
                                    'rgba(67, 97, 238, 0.7)',
                                    'rgba(247, 37, 133, 0.7)',
                                    'rgba(248, 150, 30, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(67, 97, 238, 1)',
                                    'rgba(67, 97, 238, 1)',
                                    'rgba(247, 37, 133, 1)',
                                    'rgba(67, 97, 238, 1)',
                                    'rgba(247, 37, 133, 1)',
                                    'rgba(248, 150, 30, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Risk Percentage'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Predicted Risk Levels by Area'
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error initializing charts:', error);
                addNotification('Failed to load charts', 'error');
            }
        }
        
        // Alert Polling with proper management
        function startAlertPolling() {
            // Clear any existing interval
            stopAlertPolling();
            
            // Initial fetch
            fetchAlerts();
            
            // Set up polling
            alertPollingInterval = setInterval(fetchAlerts, 5000); // Poll every 5 seconds
        }
        
        function stopAlertPolling() {
            if (alertPollingInterval) {
                clearInterval(alertPollingInterval);
                alertPollingInterval = null;
            }
        }
        
        function fetchAlerts() {
            fetch(`${API_BASE_URL}/alerts`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateAlertLog(data);
                })
                .catch(error => {
                    console.error('Error fetching alerts:', error);
                    // Don't show notification for polling errors to avoid spam
                });
        }
        
        function updateAlertLog(alerts) {
            const alertLogContainer = document.getElementById('alertLogContainer');
            
            if (!alertLogContainer) return;
            
            // Clear existing alerts
            alertLogContainer.innerHTML = '';
            
            // Add new alerts
            alerts.forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'alert-log-item';
                
                const alertTypeClass = alert.alert_type === 'anomaly' ? 'anomaly' : 'geofence';
                
                alertItem.innerHTML = `
                    <div>
                        <span class="alert-log-type ${alertTypeClass}">${alert.alert_type.toUpperCase()}</span>
                        <span>${alert.message}</span>
                    </div>
                    <div class="alert-log-time">${new Date(alert.timestamp).toLocaleString()}</div>
                `;
                
                alertLogContainer.appendChild(alertItem);
            });
            
            // If no alerts, show message
            if (alerts.length === 0) {
                alertLogContainer.innerHTML = '<div class="text-center p-3">No alerts</div>';
            }
        }
        
        // Refresh alert log button
        document.getElementById('refreshAlertLogBtn').addEventListener('click', function() {
            fetchAlerts();
            addNotification('Alert log refreshed', 'success');
        });
        
        // SOS functionality with retry logic
        function sendSOSAlert() {
            // Check if we have emergency contacts
            if (emergencyContacts.length === 0) {
                addNotification('No emergency contacts configured. Please add emergency contacts first.', 'error');
                return;
            }
            
            // Use the new SOS to contacts functionality with MFA
            showMfaVerification('sos', function(success) {
                if (success) {
                    sendSosToContacts();
                }
            });
        }
        
        // Emergency Contacts Functions
        // Load emergency contacts from localStorage
        function loadEmergencyContacts() {
            const savedContacts = localStorage.getItem('emergencyContacts');
            if (savedContacts) {
                emergencyContacts = JSON.parse(savedContacts);
            } else {
                // Initialize with default contacts if none exist
                emergencyContacts = [
                    {
                        id: Date.now().toString(),
                        name: 'John Doe',
                        phone: '9876543210',
                        relationship: 'Family',
                        email: 'john@example.com',
                        isPrimary: true
                    }
                ];
                saveEmergencyContacts();
            }
            renderEmergencyContacts();
        }
        
        // Save emergency contacts to localStorage
        function saveEmergencyContacts() {
            localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
        }
        
        // Render emergency contacts list
        function renderEmergencyContacts() {
            const contactsList = document.getElementById('contactsList');
            const emptyMessage = document.getElementById('emptyContactsMessage');
            
            if (!contactsList) return;
            
            contactsList.innerHTML = '';
            
            if (emergencyContacts.length === 0) {
                emptyMessage.style.display = 'block';
                return;
            }
            
            emptyMessage.style.display = 'none';
            
            emergencyContacts.forEach(contact => {
                const contactCard = document.createElement('div');
                contactCard.className = 'card';
                contactCard.innerHTML = `
                    <div class="flex align-center mb-2">
                        <div class="profile-upload">
                            <img src="https://picsum.photos/seed/${contact.id}/60/60.jpg" alt="${contact.name}" class="profile-img" style="width: 60px; height: 60px;">
                        </div>
                        <div class="ml-3">
                            <h4>${contact.name} ${contact.isPrimary ? '<span class="status-indicator"></span>' : ''}</h4>
                            <p>${contact.relationship || 'No relationship specified'}</p>
                        </div>
                    </div>
                    <div class="flex align-center mb-2">
                        <i class="fas fa-phone" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        <span>${contact.phone}</span>
                    </div>
                    ${contact.email ? `
                    <div class="flex align-center mb-2">
                        <i class="fas fa-envelope" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        <span>${contact.email}</span>
                    </div>
                    ` : ''}
                    <div class="flex justify-between">
                        <button class="btn btn-primary btn-sm" onclick="callContact('${contact.phone}')">
                            <i class="fas fa-phone"></i> Call
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editContact('${contact.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteContact('${contact.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ${!contact.isPrimary ? `
                        <button class="btn btn-success btn-sm" onclick="setPrimaryContact('${contact.id}')">
                            <i class="fas fa-star"></i> Set Primary
                        </button>
                        ` : ''}
                    </div>
                `;
                contactsList.appendChild(contactCard);
            });
        }
        
        // Add or update contact with MFA
        function saveContact(contactData) {
            showMfaVerification('contacts', function(success) {
                if (success) {
                    if (editingContactId) {
                        // Update existing contact
                        const index = emergencyContacts.findIndex(c => c.id === editingContactId);
                        if (index !== -1) {
                            emergencyContacts[index] = { ...emergencyContacts[index], ...contactData };
                        }
                        editingContactId = null;
                    } else {
                        // Add new contact
                        const newContact = {
                            id: Date.now().toString(),
                            ...contactData
                        };
                        emergencyContacts.push(newContact);
                    }
                    
                    saveEmergencyContacts();
                    renderEmergencyContacts();
                    loadEmergencyContactsForEmergencyPage(); // Update emergency page
                    document.getElementById('contactModal').classList.add('hidden');
                    
                    const message = editingContactId ? 'Contact updated successfully' : 'Contact added successfully';
                    addNotification(message, 'success');
                }
            });
        }
        
        // Edit contact
        function editContact(contactId) {
            const contact = emergencyContacts.find(c => c.id === contactId);
            if (!contact) return;
            
            editingContactId = contactId;
            
            // Populate form
            document.getElementById('contactId').value = contact.id;
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactPhone').value = contact.phone;
            document.getElementById('contactRelationship').value = contact.relationship || '';
            document.getElementById('contactEmail').value = contact.email || '';
            document.getElementById('contactPrimary').checked = contact.isPrimary || false;
            
            // Update modal title
            document.getElementById('contactModalTitle').textContent = 'Edit Emergency Contact';
            
            // Show modal
            document.getElementById('contactModal').classList.remove('hidden');
        }
        
        // Delete contact
        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact?')) {
                emergencyContacts = emergencyContacts.filter(c => c.id !== contactId);
                saveEmergencyContacts();
                renderEmergencyContacts();
                loadEmergencyContactsForEmergencyPage(); // Update emergency page
                addNotification('Contact deleted successfully', 'success');
            }
        }
        
        // Set primary contact
        function setPrimaryContact(contactId) {
            // Remove primary from all contacts
            emergencyContacts.forEach(contact => {
                contact.isPrimary = false;
            });
            
            // Set new primary
            const contact = emergencyContacts.find(c => c.id === contactId);
            if (contact) {
                contact.isPrimary = true;
                saveEmergencyContacts();
                renderEmergencyContacts();
                loadEmergencyContactsForEmergencyPage(); // Update emergency page
                addNotification(`${contact.name} set as primary contact`, 'success');
            }
        }
        
        // Call contact
        function callContact(phoneNumber) {
            // In a real app, this would initiate a phone call
            addNotification(`Calling ${phoneNumber}...`, 'info');
            
            // Simulate call
            setTimeout(() => {
                addNotification('Call connected', 'success');
            }, 1000);
        }
        
        // Send SOS to emergency contacts
        function sendSosToContacts() {
            const sosToAll = document.getElementById('sosToAllToggle').checked;
            const includeLocation = document.getElementById('sosLocationToggle').checked;
            
            // Get primary contact
            const primaryContact = emergencyContacts.find(c => c.isPrimary);
            
            // Get contacts to notify
            let contactsToNotify = [];
            if (primaryContact) {
                contactsToNotify.push(primaryContact);
            }
            
            if (sosToAll) {
                // Add all non-primary contacts
                emergencyContacts.forEach(contact => {
                    if (!contact.isPrimary) {
                        contactsToNotify.push(contact);
                    }
                });
            }
            
            if (contactsToNotify.length === 0) {
                addNotification('No emergency contacts to notify', 'error');
                return;
            }
            
            // Show confirmation modal
            document.getElementById('sosContactsCount').textContent = 
                `SOS will be sent to ${contactsToNotify.length} contact${contactsToNotify.length > 1 ? 's' : ''}`;
            document.getElementById('sosConfirmationModal').classList.remove('hidden');
        }
        
        // Confirm SOS alert
        function confirmSosAlert() {
            const sosToAll = document.getElementById('sosToAllToggle').checked;
            const includeLocation = document.getElementById('sosLocationToggle').checked;
            
            // Get primary contact
            const primaryContact = emergencyContacts.find(c => c.isPrimary);
            
            // Get contacts to notify
            let contactsToNotify = [];
            if (primaryContact) {
                contactsToNotify.push(primaryContact);
            }
            
            if (sosToAll) {
                // Add all non-primary contacts
                emergencyContacts.forEach(contact => {
                    if (!contact.isPrimary) {
                        contactsToNotify.push(contact);
                    }
                });
            }
            
            // Prepare SOS data
            const sosData = {
                alert_type: "sos",
                contacts: contactsToNotify,
                include_location: includeLocation,
                timestamp: new Date().toISOString()
            };
            
            // Show loading state
            addNotification('Sending SOS alert...', 'info');
            
            // Send to backend
            fetch(`${API_BASE_URL}/send_sos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(sosData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('SOS sent:', data);
                document.getElementById('sosConfirmationModal').classList.add('hidden');
                addNotification('SOS alert sent successfully', 'success');
            })
            .catch(error => {
                console.error('Error sending SOS:', error);
                document.getElementById('sosConfirmationModal').classList.add('hidden');
                addNotification('Failed to send SOS alert. Please try again.', 'error');
            });
        }
        
        // Test SOS alert
        function testSosAlert() {
            const sosToAll = document.getElementById('sosToAllToggle').checked;
            
            // Get primary contact
            const primaryContact = emergencyContacts.find(c => c.isPrimary);
            
            // Get contacts to notify
            let contactsToNotify = [];
            if (primaryContact) {
                contactsToNotify.push(primaryContact);
            }
            
            if (sosToAll) {
                // Add all non-primary contacts
                emergencyContacts.forEach(contact => {
                    if (!contact.isPrimary) {
                        contactsToNotify.push(contact);
                    }
                });
            }
            
            if (contactsToNotify.length === 0) {
                addNotification('No emergency contacts to notify', 'error');
                return;
            }
            
            // Show confirmation modal
            document.getElementById('sosContactsCount').textContent = 
                `Test SOS will be sent to ${contactsToNotify.length} contact${contactsToNotify.length > 1 ? 's' : ''}`;
            document.getElementById('sosConfirmationModal').classList.remove('hidden');
            
            // Override confirm function for test
            const originalConfirm = confirmSosAlert;
            document.getElementById('confirmSosAlertBtn').onclick = function() {
                document.getElementById('sosConfirmationModal').classList.add('hidden');
                addNotification('Test SOS alert sent successfully', 'success');
                
                // Restore original function
                document.getElementById('confirmSosAlertBtn').onclick = originalConfirm;
            };
        }
        
        // Load contacts for emergency page
        function loadEmergencyContactsForEmergencyPage() {
            const contactsList = document.getElementById('emergencyPageContactsList');
            
            if (!contactsList) return;
            
            contactsList.innerHTML = '';
            
            if (emergencyContacts.length === 0) {
                contactsList.innerHTML = '<p class="text-center">No emergency contacts added yet.</p>';
                return;
            }
            
            // Show only first 3 contacts
            const displayContacts = emergencyContacts.slice(0, 3);
            
            displayContacts.forEach(contact => {
                const contactItem = document.createElement('div');
                contactItem.className = 'flex align-center mb-2';
                contactItem.innerHTML = `
                    <img src="https://picsum.photos/seed/${contact.id}/40/40.jpg" alt="${contact.name}" class="profile-img" style="width: 40px; height: 40px;">
                    <div class="ml-2">
                        <h4>${contact.name} ${contact.isPrimary ? '<span class="status-indicator"></span>' : ''}</h4>
                        <p>${contact.phone}</p>
                    </div>
                    <button class="btn btn-danger btn-sm ml-auto" onclick="callContact('${contact.phone}')">
                        <i class="fas fa-phone"></i>
                    </button>
                `;
                contactsList.appendChild(contactItem);
            });
            
            if (emergencyContacts.length > 3) {
                const moreItem = document.createElement('div');
                moreItem.className = 'text-center mt-2';
                moreItem.innerHTML = `<a href="#" onclick="navigateToEmergencyContacts()">View all ${emergencyContacts.length} contacts</a>`;
                contactsList.appendChild(moreItem);
            }
        }
        
        // Navigate to emergency contacts page
        function navigateToEmergencyContacts() {
            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.classList.remove('active');
            });
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.getElementById('emergencyContactsPage').classList.add('active');
            
            // Initialize the emergency contacts page
            initEmergencyContacts();
        }
        
        // Initialize emergency contacts functionality
        function initEmergencyContacts() {
            // Load contacts from localStorage
            loadEmergencyContacts();
            
            // Add contact button
            const addContactBtn = document.getElementById('addContactBtn');
            if (addContactBtn) {
                addContactBtn.addEventListener('click', function() {
                    editingContactId = null;
                    document.getElementById('contactForm').reset();
                    document.getElementById('contactModalTitle').textContent = 'Add Emergency Contact';
                    document.getElementById('contactModal').classList.remove('hidden');
                });
            }
            
            // Close contact modal
            const closeContactModal = document.getElementById('closeContactModal');
            if (closeContactModal) {
                closeContactModal.addEventListener('click', function() {
                    document.getElementById('contactModal').classList.add('hidden');
                });
            }
            
            // Contact form submission
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get form data
                    const contactData = {
                        name: document.getElementById('contactName').value.trim(),
                        phone: document.getElementById('contactPhone').value.trim(),
                        relationship: document.getElementById('contactRelationship').value.trim(),
                        email: document.getElementById('contactEmail').value.trim(),
                        isPrimary: document.getElementById('contactPrimary').checked
                    };
                    
                    // Validate form
                    if (!contactData.name || !contactData.phone) {
                        addNotification('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    // If setting as primary, remove primary from all contacts
                    if (contactData.isPrimary) {
                        emergencyContacts.forEach(contact => {
                            contact.isPrimary = false;
                        });
                    }
                    
                    // Save contact with MFA
                    saveContact(contactData);
                });
            }
            
            // Test SOS button
            const testSosBtn = document.getElementById('testSosBtn');
            if (testSosBtn) {
                testSosBtn.addEventListener('click', testSosAlert);
            }
            
            // SOS confirmation modal
            const closeSosConfirmationModal = document.getElementById('closeSosConfirmationModal');
            if (closeSosConfirmationModal) {
                closeSosConfirmationModal.addEventListener('click', function() {
                    document.getElementById('sosConfirmationModal').classList.add('hidden');
                });
            }
            
            const cancelSosAlertBtn = document.getElementById('cancelSosAlertBtn');
            if (cancelSosAlertBtn) {
                cancelSosAlertBtn.addEventListener('click', function() {
                    document.getElementById('sosConfirmationModal').classList.add('hidden');
                });
            }
            
            const confirmSosAlertBtn = document.getElementById('confirmSosAlertBtn');
            if (confirmSosAlertBtn) {
                confirmSosAlertBtn.addEventListener('click', confirmSosAlert);
            }
            
            // Update SOS settings in localStorage when changed
            const sosToAllToggle = document.getElementById('sosToAllToggle');
            if (sosToAllToggle) {
                sosToAllToggle.addEventListener('change', function() {
                    localStorage.setItem('sosToAll', this.checked);
                });
            }
            
            const sosLocationToggle = document.getElementById('sosLocationToggle');
            if (sosLocationToggle) {
                sosLocationToggle.addEventListener('change', function() {
                    localStorage.setItem('sosLocation', this.checked);
                });
            }
            
            // Load SOS settings from localStorage
            const sosToAll = localStorage.getItem('sosToAll');
            if (sosToAll !== null && sosToAllToggle) {
                sosToAllToggle.checked = sosToAll === 'true';
            }
            
            const sosLocation = localStorage.getItem('sosLocation');
            if (sosLocation !== null && sosLocationToggle) {
                sosLocationToggle.checked = sosLocation === 'true';
            }
        }
        
        // Improved QR code generation
        function generateQRCode(data, touristId) {
            const qrContainer = document.getElementById('qrSection');
            const qrCanvas = document.getElementById('qrcode');
            
            if (!qrContainer || !qrCanvas) {
                console.error('QR code elements not found');
                addNotification('Failed to generate QR code', 'error');
                return;
            }
            
            try {
                QRCode.toCanvas(qrCanvas, data, {
                    width: 256,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) {
                        console.error("QR error:", error);
                        addNotification("Failed to generate QR code.", "error");
                    } else {
                        // Show QR section
                        qrContainer.classList.remove("hidden");
                        
                        // Enable download
                        document.getElementById("downloadQR").onclick = function() {
                            try {
                                const link = document.createElement("a");
                                link.download = `tourist-id-${touristId}.png`;
                                link.href = qrCanvas.toDataURL();
                                link.click();
                            } catch (err) {
                                console.error('Error downloading QR code:', err);
                                addNotification('Failed to download QR code', 'error');
                            }
                        };
                    }
                });
            } catch (error) {
                console.error('Error generating QR code:', error);
                addNotification('Failed to generate QR code', 'error');
            }
        }
        
        // Tourist Registration with improved Web3Modal integration
        async function initTouristPage() {
            // Contract ABI (for blockchain method)
            const contractABI = [
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "_name",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_passportOrAadhaar",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_emergencyContact",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_tripStartDate",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_tripEndDate",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_itinerary",
                            "type": "string"
                        }
                    ],
                    "name": "registerTourist",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "id",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "passportOrAadhaar",
                            "type": "string"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "emergencyContact",
                            "type": "string"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "tripStartDate",
                            "type": "string"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "tripEndDate",
                            "type": "string"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "_itinerary",
                            "type": "string"
                        }
                    ],
                    "name": "TouristRegistered",
                    "type": "event"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "_id",
                            "type": "uint256"
                        }
                    ],
                    "name": "getTourist",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        },
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "touristCount",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "name": "tourists",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "id",
                            "type": "uint256"
                        },
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "passportOrAadhaar",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "emergencyContact",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "tripStartDate",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "tripEndDate",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "itinerary",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ];
            
            // Contract Address (Sepolia Testnet)
            const contractAddress = "0xC07D0D527fEF97ce682f4cC1D08F98E128583B21";
            
            let registrationMethod = 'blockchain';
            
            // Load Web3Modal and WalletConnectProvider if not available
            if (typeof window.Web3Modal === 'undefined' || typeof window.WalletConnectProvider === 'undefined') {
                try {
                    await Promise.all([
                        loadScript('https://unpkg.com/web3modal@1.9.0/dist/index.js'),
                        loadScript('https://unpkg.com/@walletconnect/web3-provider@1.7.1/dist/umd/index.min.js')
                    ]);
                } catch (error) {
                    console.error('Failed to load Web3Modal libraries:', error);
                    addNotification('Failed to load wallet connection libraries', 'error');
                }
            }
            
            // Initialize Web3Modal (for blockchain method)
            try {
                const providerOptions = {
                    walletconnect: {
                        package: window.WalletConnectProvider,
                        options: {
                            infuraId: "YOUR_INFURA_ID" // Replace with your Infura ID
                        }
                    }
                };
                
                web3Modal = new window.Web3Modal({
                    cacheProvider: false,
                    providerOptions,
                    theme: "light",
                    disableInjectedProvider: false
                });
                
            } catch (error) {
                console.error('Web3Modal initialization failed:', error);
                addNotification('Failed to initialize wallet connection', 'error');
            }
            
            // Handle registration method selection
            document.querySelectorAll('input[name="regMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    registrationMethod = this.value;
                    
                    if (registrationMethod === 'blockchain') {
                        document.getElementById('blockchainSection').classList.remove('hidden');
                        document.getElementById('simpleSection').classList.add('hidden');
                    } else {
                        document.getElementById('blockchainSection').classList.add('hidden');
                        document.getElementById('simpleSection').classList.remove('hidden');
                    }
                });
            });
            
            // Connect wallet function (for blockchain method)
            async function connectWallet() {
                try {
                    if (!web3Modal) {
                        const initialized = await initWeb3Modal();
                        if (!initialized) return;
                    }
                    
                    const provider = await web3Modal.connect();
                    web3 = new Web3(provider);
                    
                    const accounts = await web3.eth.getAccounts();
                    account = accounts[0];
                    
                    // Update UI
                    document.getElementById("walletStatus").textContent = `Connected: ${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
                    document.getElementById("walletStatusIndicator").textContent = "Connected";
                    
                    // Create contract instance
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    
                    // Subscribe to provider events
                    provider.on("accountsChanged", (accounts) => {
                        if (accounts.length === 0) {
                            document.getElementById("walletStatus").textContent = "Not connected";
                            document.getElementById("walletStatusIndicator").textContent = "";
                        } else {
                            account = accounts[0];
                            document.getElementById("walletStatus").textContent = `Connected: ${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
                        }
                    });
                    
                    return true;
                } catch (error) {
                    console.error("Wallet connection failed:", error);
                    addNotification("Failed to connect wallet. Please try again.", "error");
                    return false;
                }
            }
            
            // Connect button event
            document.getElementById("connectBtn").addEventListener("click", connectWallet);
            
            // Form submission with validation
            document.getElementById("regForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                
                // Get form values
                const name = document.getElementById("name").value.trim();
                const passport = document.getElementById("passport").value.trim();
                const emergencyContact = document.getElementById("emergencyContact").value.trim();
                const tripStart = document.getElementById("tripStart").value.trim();
                const tripEnd = document.getElementById("tripEnd").value.trim();
                const itinerary = document.getElementById("itinerary").value.trim();
                
                // Form validation
                if (!name || !passport || !emergencyContact || !tripStart || !tripEnd || !itinerary) {
                    addNotification("Please fill in all required fields", 'error');
                    return;
                }
                
                // Validate dates
                if (new Date(tripStart) > new Date(tripEnd)) {
                    addNotification("Trip end date must be after start date", 'error');
                    return;
                }
                
                let touristId;
                let verificationData;
                
                if (registrationMethod === 'blockchain') {
                    // Blockchain registration
                    if (!contract || !account) {
                        addNotification("Please connect your wallet first", 'error');
                        return;
                    }
                    
                    try {
                        // Show loading state
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';
                        submitBtn.disabled = true;
                        
                        const receipt = await contract.methods
                            .registerTourist(name, passport, emergencyContact, tripStart, tripEnd, itinerary)
                            .send({ from: account });
                        
                        touristId = receipt.events.TouristRegistered.returnValues.id;
                        const txHash = receipt.transactionHash;
                        
                        verificationData = {
                            method: 'blockchain',
                            touristId: touristId,
                            name: name,
                            txHash: txHash,
                            contractAddress: contractAddress
                        };
                        
                        addNotification("Registration successful! Your data is secured on the blockchain.", 'success');
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        
                    } catch (err) {
                        console.error("Error while registering:", err);
                        
                        // Reset button
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        
                        if (err.code === 4001) {
                            addNotification("Transaction rejected by user.", 'error');
                        } else {
                            addNotification("Registration failed. Please try again.", 'error');
                        }
                        return;
                    }
                } else {
                    // Simple registration
                    const email = document.getElementById("email").value.trim();
                    const phone = document.getElementById("phone").value.trim();
                    
                    // Validate email and phone for simple registration
                    if (!email || !phone) {
                        addNotification("Please provide email and phone for simple registration", 'error');
                        return;
                    }
                    
                    // Generate a unique ID (in a real app, this would come from your backend)
                    touristId = 'TOURIST-' + Date.now().toString(36) + Math.random().toString(36).substr(2);
                    
                    verificationData = {
                        method: 'simple',
                        touristId: touristId,
                        name: name,
                        email: email,
                        phone: phone,
                        timestamp: new Date().toISOString()
                    };
                    
                    // In a real app, you would send this data to your backend
                    console.log("Simple registration data:", verificationData);
                    
                    addNotification("Registration successful! Your tourist ID has been generated.", 'success');
                }
                
                // Generate QR code
                generateQRCode(JSON.stringify(verificationData), touristId);
                
                // Update result text
                document.getElementById("result").innerHTML = `
                    <p><b>Tourist Registered Successfully!</b><br>
                    ID: ${touristId}<br>
                    Name: ${name}<br>
                    Method: ${registrationMethod === 'blockchain' ? 'Blockchain Secured' : 'Simple Registration'}</p>
                `;
                
                // Reset form
                e.target.reset();
            });
        }
        
        // Notification System
        function addNotification(message, type = 'info', showToast = true) {
            const notification = {
                id: Date.now(),
                message: message,
                type: type,
                timestamp: new Date(),
                read: false
            };
            
            // Add to notifications array
            notifications.unshift(notification);
            
            // Limit notifications to 50
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            // Update unread count
            if (!notification.read) {
                unreadCount++;
                updateNotificationBadge();
            }
            
            // Update notification list
            updateNotificationList();
            
            // Show toast notification if requested
            if (showToast) {
                showNotificationToast(message, type);
            }
        }
        
        function showNotificationToast(message, type = 'info') {
            const notificationContainer = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex justify-between">
                    <span>${message}</span>
                    <span class="close" style="cursor: pointer;">&times;</span>
                </div>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(function() {
                notification.remove();
            }, 5000);
            
            // Remove on click
            notification.querySelector('.close').addEventListener('click', function() {
                notification.remove();
            });
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function updateNotificationList() {
            const notificationList = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
                return;
            }
            
            notificationList.innerHTML = '';
            
            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationItem.dataset.id = notification.id;
                
                const iconClass = notification.type === 'success' ? 'check-circle' : 
                                 notification.type === 'error' ? 'exclamation-circle' : 
                                 notification.type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                
                notificationItem.innerHTML = `
                    <div class="notification-item-header">
                        <div class="notification-item-title">
                            <i class="fas fa-${iconClass} notification-type-icon ${notification.type}"></i>
                            ${notification.type.charAt(0).toUpperCase() + notification.type.slice(1)}
                        </div>
                        <div class="notification-item-time">${formatTime(notification.timestamp)}</div>
                    </div>
                    <div class="notification-item-content">${notification.message}</div>
                `;
                
                notificationItem.addEventListener('click', function() {
                    if (!notification.read) {
                        notification.read = true;
                        unreadCount--;
                        updateNotificationBadge();
                        notificationItem.classList.remove('unread');
                    }
                });
                
                notificationList.appendChild(notificationItem);
            });
        }
        
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} ago`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else if (minutes > 0) {
                return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else {
                return 'Just now';
            }
        }
        
        function clearAllNotifications() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            unreadCount = 0;
            updateNotificationBadge();
            updateNotificationList();
        }
        
        // Data Usage Page Functions
        function initDataUsagePage() {
            // Destroy existing chart instances if they exist
            if (dataUsageChartInstance) {
                dataUsageChartInstance.destroy();
                dataUsageChartInstance = null;
            }
            
            if (dataUsageBreakdownChartInstance) {
                dataUsageBreakdownChartInstance.destroy();
                dataUsageBreakdownChartInstance = null;
            }
            
            // Data Usage Over Time Chart
            const dataUsageCtx = document.getElementById('dataUsageChart');
            if (dataUsageCtx) {
                dataUsageChartInstance = new Chart(dataUsageCtx, {
                    type: 'line',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: [{
                            label: 'Data Usage (MB)',
                            data: [65, 78, 90, 245],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'MB'
                                }
                            }
                        }
                    }
                });
            }
            
            // Data Usage Breakdown Chart
            const dataUsageBreakdownCtx = document.getElementById('dataUsageBreakdownChart');
            if (dataUsageBreakdownCtx) {
                dataUsageBreakdownChartInstance = new Chart(dataUsageBreakdownCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Maps', 'Notifications', 'Emergency Services', 'Profile Sync', 'Other'],
                        datasets: [{
                            data: [120, 45, 35, 25, 20],
                            backgroundColor: [
                                '#4361ee',
                                '#f72585',
                                '#4cc9f0',
                                '#f8961e',
                                '#7209b7'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Data Limit Toggle
            const dataLimitToggle = document.getElementById('dataLimitToggle');
            const dataLimitSettings = document.getElementById('dataLimitSettings');
            
            // Load saved setting
            const savedDataLimit = localStorage.getItem('dataLimitEnabled');
            if (savedDataLimit !== null) {
                dataLimitToggle.checked = savedDataLimit === 'true';
                dataLimitSettings.style.display = dataLimitToggle.checked ? 'block' : 'none';
            }
            
            // Load saved limit value
            const savedLimitValue = localStorage.getItem('dataLimitValue');
            if (savedLimitValue) {
                document.getElementById('dataLimitValue').value = savedLimitValue;
                updateDataRemaining();
            }
            
            dataLimitToggle.addEventListener('change', function() {
                localStorage.setItem('dataLimitEnabled', this.checked);
                dataLimitSettings.style.display = this.checked ? 'block' : 'none';
                updateDataRemaining();
                
                if (this.checked) {
                    addNotification('Data limit enabled', 'success');
                } else {
                    addNotification('Data limit disabled', 'info');
                }
            });
            
            // Data Limit Value Change
            document.getElementById('dataLimitValue').addEventListener('change', function() {
                localStorage.setItem('dataLimitValue', this.value);
                updateDataRemaining();
            });
            
            // Reduce Data Usage Toggle
            const reduceDataUsageToggle = document.getElementById('reduceDataUsageToggle');
            if (reduceDataUsageToggle) {
                // Load saved setting
                const savedSetting = localStorage.getItem('reduceDataUsage');
                if (savedSetting !== null) {
                    reduceDataUsageToggle.checked = savedSetting === 'true';
                }
                
                reduceDataUsageToggle.addEventListener('change', function() {
                    localStorage.setItem('reduceDataUsage', this.checked);
                    addNotification(`Data usage reduction ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                });
            }
            
            // Background Data Toggle
            const backgroundDataToggle = document.getElementById('backgroundDataToggle');
            if (backgroundDataToggle) {
                // Load saved setting
                const savedSetting = localStorage.getItem('backgroundData');
                if (savedSetting !== null) {
                    backgroundDataToggle.checked = savedSetting === 'true';
                }
                
                backgroundDataToggle.addEventListener('change', function() {
                    localStorage.setItem('backgroundData', this.checked);
                    addNotification(`Background data ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                });
            }
            
            // Auto-download Maps Toggle
            const autoDownloadMapsToggle = document.getElementById('autoDownloadMapsToggle');
            if (autoDownloadMapsToggle) {
                // Load saved setting
                const savedSetting = localStorage.getItem('autoDownloadMaps');
                if (savedSetting !== null) {
                    autoDownloadMapsToggle.checked = savedSetting === 'true';
                }
                
                autoDownloadMapsToggle.addEventListener('change', function() {
                    localStorage.setItem('autoDownloadMaps', this.checked);
                    addNotification(`Auto-download maps ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                });
            }
            
            // Refresh button
            document.getElementById('refreshDataUsageBtn').addEventListener('click', function() {
                // Simulate refreshing data
                addNotification('Data usage refreshed', 'success');
                
                // Update with random values for demo
                const randomUsage = Math.floor(Math.random() * 100) + 200;
                document.getElementById('currentDataUsage').textContent = randomUsage + ' MB';
                updateDataRemaining();
            });
            
            // Reset button
            document.getElementById('resetDataUsageBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset data usage statistics?')) {
                    // Reset displayed values
                    document.getElementById('currentDataUsage').textContent = '0 MB';
                    document.getElementById('dailyAverage').textContent = '0 MB';
                    updateDataRemaining();
                    
                    // Reset charts
                    if (dataUsageChartInstance) {
                        dataUsageChartInstance.data.datasets[0].data = [0, 0, 0, 0];
                        dataUsageChartInstance.update();
                    }
                    
                    if (dataUsageBreakdownChartInstance) {
                        dataUsageBreakdownChartInstance.data.datasets[0].data = [0, 0, 0, 0, 0];
                        dataUsageBreakdownChartInstance.update();
                    }
                    
                    addNotification('Data usage statistics reset', 'success');
                }
            });
        }
        
        // Update data remaining based on current usage and limit
        function updateDataRemaining() {
            const currentUsage = parseInt(document.getElementById('currentDataUsage').textContent) || 0;
            const limitEnabled = document.getElementById('dataLimitToggle').checked;
            const limitValue = parseInt(document.getElementById('dataLimitValue').value) || 1000;
            
            if (limitEnabled) {
                const remaining = Math.max(0, limitValue - currentUsage);
                document.getElementById('dataRemaining').textContent = remaining + ' MB';
                
                // Update progress bar
                const progressBar = document.getElementById('dataUsageProgressBar');
                const percentage = (currentUsage / limitValue) * 100;
                progressBar.style.width = percentage + '%';
                
                // Change color based on percentage
                if (percentage >= 90) {
                    progressBar.classList.add('danger');
                    progressBar.classList.remove('warning');
                } else if (percentage >= 70) {
                    progressBar.classList.add('warning');
                    progressBar.classList.remove('danger');
                } else {
                    progressBar.classList.remove('warning', 'danger');
                }
                
                // Check if approaching limit
                if (remaining > 0 && remaining < limitValue * 0.2) {
                    addNotification('You are approaching your data limit', 'warning');
                }
            } else {
                document.getElementById('dataRemaining').textContent = 'Unlimited';
                document.getElementById('dataUsageProgressBar').style.width = '0%';
            }
        }
        
        // Cookie Preferences Functions
        function initCookiePreferences() {
            // Load saved cookie preferences
            const savedPreferences = localStorage.getItem('cookiePreferences');
            if (savedPreferences) {
                cookiePreferences = JSON.parse(savedPreferences);
            }
            
            // Cookie Preferences Button
            const cookiePreferencesBtn = document.getElementById('cookiePreferencesBtn');
            if (cookiePreferencesBtn) {
                cookiePreferencesBtn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.getElementById('cookiePreferencesPage').classList.add('active');
                    
                    // Initialize the cookie preferences page
                    loadCookiePreferences();
                });
            }
            
            // Close Cookie Modal
            const closeCookieModal = document.getElementById('closeCookieModal');
            if (closeCookieModal) {
                closeCookieModal.addEventListener('click', function() {
                    document.getElementById('cookieModal').classList.add('hidden');
                });
            }
            
            // Save Cookie Preferences
            const saveCookiePreferencesBtn = document.getElementById('saveCookiePreferences');
            if (saveCookiePreferencesBtn) {
                saveCookiePreferencesBtn.addEventListener('click', function() {
                    cookiePreferences = {
                        essential: true, // Always enabled
                        analytics: document.getElementById('analyticsCookies').checked,
                        marketing: document.getElementById('marketingCookies').checked,
                        timestamp: new Date().toISOString()
                    };
                    
                    localStorage.setItem('cookiePreferences', JSON.stringify(cookiePreferences));
                    document.getElementById('cookieModal').classList.add('hidden');
                    addNotification('Cookie preferences saved successfully', 'success');
                    
                    // In a real app, you would also update your cookie consent implementation
                    console.log('Cookie preferences updated:', cookiePreferences);
                });
            }
        }
        
        // Load Cookie Preferences
        function loadCookiePreferences() {
            const savedPreferences = localStorage.getItem('cookiePreferences');
            if (savedPreferences) {
                const preferences = JSON.parse(savedPreferences);
                document.getElementById('analyticsCookies').checked = preferences.analytics || false;
                document.getElementById('marketingCookies').checked = preferences.marketing || false;
            } else {
                // Default preferences
                document.getElementById('analyticsCookies').checked = false;
                document.getElementById('marketingCookies').checked = false;
            }
        }
        
        // Ad Choices Functions
        function initAdChoices() {
            // Load saved ad preferences
            const savedAdPreferences = localStorage.getItem('adPreferences');
            if (savedAdPreferences) {
                adPreferences = JSON.parse(savedAdPreferences);
                
                // Set toggle states
                document.getElementById('personalizedAdsToggle').checked = adPreferences.personalizedAds || false;
                document.getElementById('locationBasedAdsToggle').checked = adPreferences.locationBasedAds || false;
                document.getElementById('reduceAdFrequencyToggle').checked = adPreferences.reduceAdFrequency || false;
                
                // Set category checkboxes
                if (adPreferences.categories) {
                    Object.keys(adPreferences.categories).forEach(category => {
                        const checkbox = document.getElementById(`adCategory${category.charAt(0).toUpperCase() + category.slice(1)}`);
                        if (checkbox) {
                            checkbox.checked = adPreferences.categories[category];
                        }
                    });
                }
                
                // Set ad identifier
                if (adPreferences.adIdentifier) {
                    document.getElementById('adIdentifier').textContent = adPreferences.adIdentifier;
                }
            }
            
            // Personalized Ads Toggle
            document.getElementById('personalizedAdsToggle').addEventListener('change', function() {
                saveAdPreferences();
                addNotification(`Personalized ads ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            // Location-Based Ads Toggle
            document.getElementById('locationBasedAdsToggle').addEventListener('change', function() {
                saveAdPreferences();
                addNotification(`Location-based ads ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            // Reduce Ad Frequency Toggle
            document.getElementById('reduceAdFrequencyToggle').addEventListener('change', function() {
                saveAdPreferences();
                addNotification(`Ad frequency reduction ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            // Ad Category Checkboxes
            const categoryCheckboxes = document.querySelectorAll('#adChoicesPage input[type="checkbox"][id^="adCategory"]');
            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    saveAdPreferences();
                });
            });
            
            // Reset Ad ID Button
            document.getElementById('resetAdIdBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset your advertising identifier? This will make your previous ad preferences less effective.')) {
                    // Generate new random ID
                    const newId = 'SAFETY-APP-' + Math.random().toString(36).substring(2, 15).toUpperCase();
                    document.getElementById('adIdentifier').textContent = newId;
                    saveAdPreferences();
                    addNotification('Advertising identifier reset successfully', 'success');
                }
            });
            
            // Clear Ad History Button
            document.getElementById('clearAdHistoryBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear your ad interaction history?')) {
                    // Clear the history container
                    document.getElementById('adHistoryContainer').innerHTML = '<div class="text-center p-3">No ad history</div>';
                    addNotification('Ad history cleared successfully', 'success');
                }
            });
            
            // Reset Ad Preferences Button
            document.getElementById('resetAdPreferencesBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset all ad preferences to default?')) {
                    // Reset all toggles and checkboxes
                    document.getElementById('personalizedAdsToggle').checked = false;
                    document.getElementById('locationBasedAdsToggle').checked = false;
                    document.getElementById('reduceAdFrequencyToggle').checked = false;
                    
                    // Reset all category checkboxes
                    categoryCheckboxes.forEach(checkbox => {
                        checkbox.checked = checkbox.id === 'adCategorySafety' || checkbox.id === 'adCategoryHealth';
                    });
                    
                    // Reset ad identifier
                    const newId = 'SAFETY-APP-' + Math.random().toString(36).substring(2, 15).toUpperCase();
                    document.getElementById('adIdentifier').textContent = newId;
                    
                    saveAdPreferences();
                    addNotification('Ad preferences reset to default', 'success');
                }
            });
            
            // View Premium Products Button
            document.querySelector('#adChoicesPage .btn-block').addEventListener('click', function() {
                // Navigate to purchase page
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                document.querySelector('[data-page="purchasePage"]').classList.add('active');
                document.getElementById('purchasePage').classList.add('active');
                
                addNotification('Redirected to premium products', 'info');
            });
        }
        
        function saveAdPreferences() {
            const preferences = {
                personalizedAds: document.getElementById('personalizedAdsToggle').checked,
                locationBasedAds: document.getElementById('locationBasedAdsToggle').checked,
                reduceAdFrequency: document.getElementById('reduceAdFrequencyToggle').checked,
                categories: {},
                adIdentifier: document.getElementById('adIdentifier').textContent,
                timestamp: new Date().toISOString()
            };
            
            // Save category preferences
            const categoryCheckboxes = document.querySelectorAll('#adChoicesPage input[type="checkbox"][id^="adCategory"]');
            categoryCheckboxes.forEach(checkbox => {
                const category = checkbox.id.replace('adCategory', '').toLowerCase();
                preferences.categories[category] = checkbox.checked;
            });
            
            localStorage.setItem('adPreferences', JSON.stringify(preferences));
        }
        
        // Page Navigation with proper event management
        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get the target page
                    const pageId = this.getAttribute('data-page');
                    const targetPage = document.getElementById(pageId);
                    
                    // Check if page exists
                    if (!targetPage) {
                        console.error(`Page ${pageId} not found`);
                        return;
                    }
                    
                    // Remove active class from all nav items and pages
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    // Add active class to clicked nav item and corresponding page
                    this.classList.add('active');
                    targetPage.classList.add('active');
                    
                    // Reset header to normal when navigating away from government dashboard
                    document.getElementById('appHeader').classList.remove('gov-header');
                    
                    // Page-specific initialization
                    if (pageId === 'mapPage') {
                        setTimeout(() => safeInitMap('userMap', initUserMap), 100);
                    } else if (pageId === 'govDashboardPage') {
                        setTimeout(() => {
                            initCharts();
                            safeInitMap('govMap', initGovMap);
                            startAlertPolling();
                        }, 100);
                    } else if (pageId === 'touristPage') {
                        setTimeout(initTouristPage, 100);
                    } else if (pageId === 'devicePermissionsPage') {
                        setTimeout(loadDevicePermissions, 100);
                    } else if (pageId === 'linkedDevicesPage') {
                        setTimeout(initLinkedDevices, 100);
                    } else if (pageId === 'dataUsagePage') {
                        setTimeout(initDataUsagePage, 100);
                    } else if (pageId === 'cookiePreferencesPage') {
                        setTimeout(loadCookiePreferences, 100);
                    } else if (pageId === 'adChoicesPage') {
                        setTimeout(initAdChoices, 100);
                    }
                });
            });
            
            // Settings Icon Navigation
            document.getElementById('settingsIcon').addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                document.querySelector('[data-page="settingsPage"]').classList.add('active');
                document.getElementById('settingsPage').classList.add('active');
                
                // Reset header to normal when navigating away from government dashboard
                document.getElementById('appHeader').classList.remove('gov-header');
            });
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize profile picture
            loadProfilePicture();
            
            // Initialize navigation
            initNavigation();
            
            // Initialize notification system
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const clearNotificationsBtn = document.getElementById('clearNotifications');
            
            // Toggle notification dropdown
            notificationIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.classList.toggle('hidden');
                
                // Mark all as read when opening
                if (!notificationDropdown.classList.contains('hidden')) {
                    notifications.forEach(notification => {
                        notification.read = true;
                    });
                    unreadCount = 0;
                    updateNotificationBadge();
                    updateNotificationList();
                }
            });
            
            // Clear all notifications
            clearNotificationsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                clearAllNotifications();
            });
            
            // Close notification dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!notificationDropdown.contains(e.target) && e.target !== notificationIcon) {
                    notificationDropdown.classList.add('hidden');
                }
            });
            
            // Dark Mode Toggle
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                }
            });
            
            // High Contrast Mode Toggle
            document.getElementById('highContrastToggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'high-contrast');
                    localStorage.setItem('theme', 'high-contrast');
                } else {
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme === 'dark') {
                        document.documentElement.setAttribute('data-theme', 'dark');
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                    }
                }
            });
            
            // Voice Assistant Toggle
            document.getElementById('voiceAssistantToggle').addEventListener('change', function() {
                if (this.checked) {
                    initVoiceAssistant();
                    addNotification('Voice assistant enabled. Click the microphone button to use voice commands.', 'success');
                } else {
                    if (voiceRecognition) {
                        voiceRecognition.stop();
                    }
                    addNotification('Voice assistant disabled.', 'info');
                }
            });
            
            // Voice Assistant Button
            document.getElementById('voiceAssistantBtn').addEventListener('click', function() {
                if (document.getElementById('voiceAssistantToggle').checked) {
                    toggleVoiceAssistant();
                } else {
                    addNotification('Please enable voice assistant in settings first', 'warning');
                }
            });
            
            // Voice Modal Close
            document.getElementById('voiceModalClose').addEventListener('click', function() {
                document.getElementById('voiceModal').classList.remove('active');
                if (isListening && voiceRecognition) {
                    voiceRecognition.stop();
                }
            });
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('darkModeToggle').checked = true;
            } else if (savedTheme === 'high-contrast') {
                document.documentElement.setAttribute('data-theme', 'high-contrast');
                document.getElementById('highContrastToggle').checked = true;
            }
            
            // Language Selection
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.language-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    addNotification(`Language changed to ${this.textContent}`, 'success');
                });
            });
            
            // SOS Button
            document.getElementById('sosButton').addEventListener('click', function() {
                document.getElementById('sosModal').classList.remove('hidden');
                startSosCountdown();
            });
            
            document.getElementById('closeSosModal').addEventListener('click', function() {
                document.getElementById('sosModal').classList.add('hidden');
                stopSosCountdown();
            });
            
            document.getElementById('cancelSosBtn').addEventListener('click', function() {
                document.getElementById('sosModal').classList.add('hidden');
                stopSosCountdown();
            });
            
            document.getElementById('confirmSosBtn').addEventListener('click', function() {
                document.getElementById('sosModal').classList.add('hidden');
                stopSosCountdown();
                
                // Send SOS to backend with MFA
                sendSOSAlert();
            });
            
            let sosCountdownInterval;
            function startSosCountdown() {
                let countdown = 5;
                document.getElementById('sosCountdown').textContent = countdown;
                
                sosCountdownInterval = setInterval(function() {
                    countdown--;
                    document.getElementById('sosCountdown').textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(sosCountdownInterval);
                        document.getElementById('sosModal').classList.add('hidden');
                        sendSOSAlert();
                    }
                }, 1000);
            }
            
            function stopSosCountdown() {
                if (sosCountdownInterval) {
                    clearInterval(sosCountdownInterval);
                    sosCountdownInterval = null;
                }
            }
            
            // Incident Report with validation
            document.getElementById('reportIncidentBtn').addEventListener('click', function() {
                document.getElementById('incidentModal').classList.remove('hidden');
            });
            
            document.getElementById('closeIncidentModal').addEventListener('click', function() {
                document.getElementById('incidentModal').classList.add('hidden');
            });
            
            document.querySelector('#incidentModal form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm(this)) {
                    addNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                // Get form data
                const incidentType = document.getElementById('incidentType').value;
                const incidentLocation = document.getElementById('incidentLocation').value;
                const incidentDescription = document.getElementById('incidentDescription').value;
                
                // Prepare incident data
                const incidentData = {
                    alert_type: "incident",
                    incident_type: incidentType,
                    location: incidentLocation,
                    message: incidentDescription,
                    timestamp: new Date().toISOString()
                };
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
                submitBtn.disabled = true;
                
                // Send to backend
                fetch(`${API_BASE_URL}/trigger_alert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(incidentData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Incident reported:', data);
                    document.getElementById('incidentModal').classList.add('hidden');
                    addNotification('Incident report submitted successfully', 'success');
                    this.reset();
                })
                .catch(error => {
                    console.error('Error reporting incident:', error);
                    addNotification('Failed to submit incident report', 'error');
                })
                .finally(() => {
                    // Reset button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
            });
            
            // Change Password with validation and MFA
            document.getElementById('changePasswordBtn').addEventListener('click', function() {
                document.getElementById('passwordModal').classList.remove('hidden');
            });
            
            document.getElementById('closePasswordModal').addEventListener('click', function() {
                document.getElementById('passwordModal').classList.add('hidden');
            });
            
            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm(this)) {
                    addNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    addNotification('Passwords do not match', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    addNotification('Password must be at least 6 characters', 'error');
                    return;
                }
                
                // Show MFA verification
                showMfaVerification('password', function(success) {
                    if (success) {
                        document.getElementById('passwordModal').classList.add('hidden');
                        addNotification('Password changed successfully', 'success');
                        document.getElementById('passwordForm').reset();
                    }
                });
            });
            
            // Government Login with MFA
            document.getElementById('govLoginBtn').addEventListener('click', function() {
                document.getElementById('govLoginModal').classList.remove('hidden');
            });
            
            document.getElementById('closeGovLoginModal').addEventListener('click', function() {
                document.getElementById('govLoginModal').classList.add('hidden');
            });
            
            document.getElementById('govLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm(this)) {
                    addNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                // Get form values
                const username = document.getElementById('govUsername').value;
                const password = document.getElementById('govPassword').value;
                const department = document.getElementById('govDepartment').value;
                
                // Check credentials
                if (username === 'govadmin' && password === 'gov123') {
                    // Show MFA verification
                    showMfaVerification('govLogin', function(success) {
                        if (success) {
                            document.getElementById('govLoginModal').classList.add('hidden');
                            
                            // Navigate to government dashboard
                            document.querySelectorAll('.nav-item').forEach(navItem => {
                                navItem.classList.remove('active');
                            });
                            document.querySelectorAll('.page').forEach(page => {
                                page.classList.remove('active');
                            });
                            
                            document.getElementById('govDashboardPage').classList.add('active');
                            
                            // Change header to government style
                            document.getElementById('appHeader').classList.add('gov-header');
                            document.querySelector('.logo span').textContent = 'Safety App - Government Dashboard';
                            
                            addNotification(`Welcome, ${username} (${department} Department)`, 'success');
                            
                            // Initialize charts and maps after showing the dashboard
                            setTimeout(function() {
                                initCharts();
                                safeInitMap('govMap', initGovMap);
                                startAlertPolling();
                            }, 100);
                            
                            document.getElementById('govLoginForm').reset();
                        }
                    });
                } else {
                    addNotification('Invalid username or password', 'error');
                }
            });
            
            // Government Logout
            document.getElementById('govLogoutBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to logout from the government dashboard?')) {
                    // Stop alert polling
                    stopAlertPolling();
                    
                    // Navigate back to home page
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.querySelector('[data-page="homePage"]').classList.add('active');
                    document.getElementById('homePage').classList.add('active');
                    
                    // Reset header to normal
                    document.getElementById('appHeader').classList.remove('gov-header');
                    document.querySelector('.logo span').textContent = 'Safety App';
                    
                    addNotification('Logged out successfully', 'success');
                }
            });
            
            // Evidence Management
            document.getElementById('addEvidenceBtn').addEventListener('click', function() {
                document.getElementById('evidenceModal').classList.remove('hidden');
            });
            
            document.getElementById('closeEvidenceModal').addEventListener('click', function() {
                document.getElementById('evidenceModal').classList.add('hidden');
            });
            
            document.getElementById('evidenceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm(this)) {
                    addNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                document.getElementById('evidenceModal').classList.add('hidden');
                addNotification('Evidence added successfully', 'success');
                this.reset();
            });
            
            // Bluetooth Toggle
            document.getElementById('toggleBluetooth').addEventListener('click', function() {
                const bluetoothStatus = document.getElementById('bluetoothStatus');
                if (bluetoothStatus.textContent === 'Off') {
                    bluetoothStatus.textContent = 'On';
                    this.textContent = 'Turn Off';
                    addNotification('Bluetooth turned on', 'success');
                } else {
                    bluetoothStatus.textContent = 'Off';
                    this.textContent = 'Turn On';
                    addNotification('Bluetooth turned off', 'success');
                }
            });
            
            // Chat Functionality
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            function sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (message === '') return;
                
                const chatMessages = document.getElementById('chatMessages');
                
                // Add user message
                const userMessage = document.createElement('div');
                userMessage.className = 'message user';
                userMessage.innerHTML = `<div class="message-content">${message}</div>`;
                chatMessages.appendChild(userMessage);
                
                // Clear input
                chatInput.value = '';
                
                // Simulate AI response
                setTimeout(function() {
                    const aiMessage = document.createElement('div');
                    aiMessage.className = 'message ai';
                    aiMessage.innerHTML = `<div class="message-content">Thank you for your message. Our team is looking into your request.</div>`;
                    chatMessages.appendChild(aiMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1000);
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to log out?')) {
                    addNotification('Logged out successfully', 'success');
                    // In a real app, this would redirect to login page
                }
            });
            
            // Profile Picture Upload Functionality
            // Home page profile upload
            const homeProfileUpload = document.getElementById('homeProfileUpload');
            const homeProfileImg = document.getElementById('homeProfileImg');
            
            homeProfileImg.addEventListener('click', function() {
                homeProfileUpload.click();
            });
            
            homeProfileUpload.addEventListener('change', function(e) {
                handleProfilePictureUpload(e.target.files[0]);
            });
            
            // Settings page profile upload
            const settingsProfileUpload = document.getElementById('settingsProfileUpload');
            const settingsProfileImg = document.getElementById('settingsProfileImg');
            
            settingsProfileImg.addEventListener('click', function() {
                settingsProfileUpload.click();
            });
            
            settingsProfileUpload.addEventListener('change', function(e) {
                handleProfilePictureUpload(e.target.files[0]);
            });
            
            // Profile picture modal
            const profilePicModal = document.getElementById('profilePicModal');
            const profilePicInput = document.getElementById('profilePicInput');
            const profilePreview = document.getElementById('profilePreview');
            const saveProfilePic = document.getElementById('saveProfilePic');
            const cancelProfilePic = document.getElementById('cancelProfilePic');
            const closeProfilePicModal = document.getElementById('closeProfilePicModal');
            
            saveProfilePic.addEventListener('click', function() {
                const newProfilePic = profilePreview.src;
                
                // Update all profile images
                document.getElementById('homeProfileImg').src = newProfilePic;
                document.getElementById('settingsProfileImg').src = newProfilePic;
                
                // Save to localStorage
                localStorage.setItem('userProfilePicture', newProfilePic);
                
                // Close modal
                profilePicModal.classList.add('hidden');
                
                addNotification('Profile picture updated successfully', 'success');
            });
            
            cancelProfilePic.addEventListener('click', function() {
                profilePicModal.classList.add('hidden');
            });
            
            closeProfilePicModal.addEventListener('click', function() {
                profilePicModal.classList.add('hidden');
            });
            
            profilePicInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle profile picture upload
            function handleProfilePictureUpload(file) {
                if (file) {
                    // Check file type
                    if (!file.type.match('image.*')) {
                        addNotification('Please select an image file', 'error');
                        return;
                    }
                    
                    // Check file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        addNotification('File size must be less than 5MB', 'error');
                        return;
                    }
                    
                    // Show modal with preview
                    const profilePicModal = document.getElementById('profilePicModal');
                    const profilePreview = document.getElementById('profilePreview');
                    const profilePicInput = document.getElementById('profilePicInput');
                    
                    profilePicModal.classList.remove('hidden');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // Set the file input value
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    profilePicInput.files = dataTransfer.files;
                }
            }
            
            // Initialize emergency contacts
            initEmergencyContacts();
            
            // Load emergency contacts for emergency page
            loadEmergencyContactsForEmergencyPage();
            
            // Wire up emergency contacts button in settings
            const emergencyContactsBtn = document.getElementById('emergencyContactsBtn');
            if (emergencyContactsBtn) {
                emergencyContactsBtn.addEventListener('click', navigateToEmergencyContacts);
            }
            
            // Device Permissions Button
            const devicePermissionsBtn = document.getElementById('devicePermissionsBtn');
            if (devicePermissionsBtn) {
                devicePermissionsBtn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.getElementById('devicePermissionsPage').classList.add('active');
                    
                    // Load device permissions
                    loadDevicePermissions();
                });
            }
            
            // Linked Devices Button
            const linkedDevicesBtn = document.getElementById('linkedDevicesBtn');
            if (linkedDevicesBtn) {
                linkedDevicesBtn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.getElementById('linkedDevicesPage').classList.add('active');
                    
                    // Initialize the linked devices page
                    initLinkedDevices();
                });
            }
            
            // Data Usage Button
            const dataUsageBtn = document.getElementById('dataUsageBtn');
            if (dataUsageBtn) {
                dataUsageBtn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.getElementById('dataUsagePage').classList.add('active');
                    
                    // Initialize the data usage page
                    initDataUsagePage();
                });
            }
            
            // Cookie Preferences Button
            const cookiePreferencesBtn = document.getElementById('cookiePreferencesBtn');
            if (cookiePreferencesBtn) {
                cookiePreferencesBtn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.getElementById('cookiePreferencesPage').classList.add('active');
                    
                    // Initialize the cookie preferences page
                    initCookiePreferences();
                });
            }
            
            // Ad Choices Button
            const adChoicesBtn = document.getElementById('adChoicesBtn');
            if (adChoicesBtn) {
                adChoicesBtn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.getElementById('adChoicesPage').classList.add('active');
                    
                    // Initialize the ad choices page
                    initAdChoices();
                });
            }
            
            // Device Permissions Toggles
            const permissionToggles = document.querySelectorAll('.permission-item input[type="checkbox"]');
            permissionToggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const permission = this.id.replace('Permission', '');
                    devicePermissions[permission] = this.checked;
                    saveDevicePermissions();
                    updatePermissionStatus(permission, this.checked);
                    
                    // Show notification based on permission
                    const permissionName = permission.charAt(0).toUpperCase() + permission.slice(1);
                    if (this.checked) {
                        addNotification(`${permissionName} permission granted`, 'success');
                    } else {
                        addNotification(`${permissionName} permission revoked`, 'info');
                    }
                });
            });
            
            // Grant All Permissions Button
            const requestAllPermissionsBtn = document.getElementById('requestAllPermissionsBtn');
            if (requestAllPermissionsBtn) {
                requestAllPermissionsBtn.addEventListener('click', function() {
                    // Enable all permissions
                    Object.keys(devicePermissions).forEach(permission => {
                        devicePermissions[permission] = true;
                        const toggle = document.getElementById(`${permission}Permission`);
                        if (toggle) {
                            toggle.checked = true;
                            updatePermissionStatus(permission, true);
                        }
                    });
                    
                    saveDevicePermissions();
                    addNotification('All permissions granted', 'success');
                });
            }
            
            // Initialize MFA
            initMFA();
            
            // Initialize Cookie Preferences
            initCookiePreferences();
            
            // Initialize Ad Choices
            initAdChoices();
            
            // Initialize Proactive SOS
            initProactiveSos();
            
            // Click outside modal to close
            window.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
            
            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                stopAlertPolling();
                stopMfaTimer();
                stopProactiveSos();
            });
            
            // Simulate initial notifications
            setTimeout(function() {
                addNotification('Welcome to Safety App!', 'success');
            }, 1000);
            
            setTimeout(function() {
                addNotification('Your safety is our priority', 'info');
            }, 3000);
            
            setTimeout(function() {
                addNotification('New safety tips available in your area', 'info');
            }, 5000);
        });
        
        // Voice Assistant Functions
        function initVoiceAssistant() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();
                
                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = false;
                voiceRecognition.lang = 'en-US';
                
                voiceRecognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    processVoiceCommand(transcript);
                };
                
                voiceRecognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    document.getElementById('voiceAssistantBtn').classList.remove('listening');
                    document.getElementById('voiceModal').classList.remove('active');
                    addNotification('Voice command not recognized. Please try again.', 'error');
                };
                
                voiceRecognition.onend = function() {
                    isListening = false;
                    document.getElementById('voiceAssistantBtn').classList.remove('listening');
                    document.getElementById('voiceModal').classList.remove('active');
                };
            } else {
                addNotification('Voice assistant not supported in this browser', 'warning');
                document.getElementById('voiceAssistantToggle').checked = false;
            }
        }
        
        function toggleVoiceAssistant() {
            if (!voiceRecognition) {
                addNotification('Voice assistant not available', 'error');
                return;
            }
            
            if (isListening) {
                voiceRecognition.stop();
                isListening = false;
                document.getElementById('voiceAssistantBtn').classList.remove('listening');
                document.getElementById('voiceModal').classList.remove('active');
            } else {
                voiceRecognition.start();
                isListening = true;
                document.getElementById('voiceAssistantBtn').classList.add('listening');
                document.getElementById('voiceModal').classList.add('active');
                document.getElementById('voiceModalContent').textContent = 'Listening... Speak now';
            }
        }
        
        function processVoiceCommand(command) {
            document.getElementById('voiceModalContent').textContent = `Command: "${command}"`;
            
            // Process different voice commands
            if (command.includes('help') || command.includes('emergency') || command.includes('sos')) {
                document.getElementById('voiceModalContent').textContent = 'Triggering SOS...';
                setTimeout(() => {
                    document.getElementById('sosModal').classList.remove('hidden');
                    startSosCountdown();
                }, 1000);
            } else if (command.includes('map')) {
                document.getElementById('voiceModalContent').textContent = 'Opening map...';
                setTimeout(() => {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.querySelector('[data-page="mapPage"]').classList.add('active');
                    document.getElementById('mapPage').classList.add('active');
                    
                    setTimeout(() => safeInitMap('userMap', initUserMap), 100);
                }, 1000);
            } else if (command.includes('contact') || command.includes('call')) {
                document.getElementById('voiceModalContent').textContent = 'Opening emergency contacts...';
                setTimeout(() => {
                    navigateToEmergencyContacts();
                }, 1000);
            } else if (command.includes('setting') || command.includes('preference')) {
                document.getElementById('voiceModalContent').textContent = 'Opening settings...';
                setTimeout(() => {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.querySelector('[data-page="settingsPage"]').classList.add('active');
                    document.getElementById('settingsPage').classList.add('active');
                }, 1000);
            } else if (command.includes('home')) {
                document.getElementById('voiceModalContent').textContent = 'Going to home...';
                setTimeout(() => {
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.querySelector('[data-page="homePage"]').classList.add('active');
                    document.getElementById('homePage').classList.add('active');
                }, 1000);
            } else {
                document.getElementById('voiceModalContent').textContent = 'Command not recognized. Please try again.';
                setTimeout(() => {
                    document.getElementById('voiceModal').classList.remove('active');
                }, 2000);
            }
        }
        
        // MFA (Multi-Factor Authentication) Functions
        function initMFA() {
            // Load MFA settings
            const savedMfaSettings = localStorage.getItem('mfaSettings');
            if (savedMfaSettings) {
                mfaSettings = JSON.parse(savedMfaSettings);
                
                // Update UI
                document.getElementById('mfaEnabledToggle').checked = mfaSettings.email || mfaSettings.sms || mfaSettings.authenticator;
                document.getElementById('mfaEmailEnabled').checked = mfaSettings.email;
                document.getElementById('mfaSmsEnabled').checked = mfaSettings.sms;
                document.getElementById('mfaAuthenticatorEnabled').checked = mfaSettings.authenticator;
                document.getElementById('mfaForSos').checked = mfaSettings.forSos;
                document.getElementById('mfaForPassword').checked = mfaSettings.forPassword;
                document.getElementById('mfaForContacts').checked = mfaSettings.forContacts;
                document.getElementById('mfaForGovLogin').checked = mfaSettings.forGovLogin;
                
                updateMfaSettingsVisibility();
            }
            
            // MFA enabled toggle
            document.getElementById('mfaEnabledToggle').addEventListener('change', function() {
                if (this.checked) {
                    // Enable at least one method
                    if (!mfaSettings.email && !mfaSettings.sms && !mfaSettings.authenticator) {
                        mfaSettings.email = true;
                        document.getElementById('mfaEmailEnabled').checked = true;
                    }
                }
                
                saveMfaSettings();
                updateMfaSettingsVisibility();
                
                addNotification(`MFA ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            // MFA method toggles
            document.getElementById('mfaEmailEnabled').addEventListener('change', function() {
                mfaSettings.email = this.checked;
                saveMfaSettings();
                
                // If all methods are disabled, disable MFA
                if (!mfaSettings.email && !mfaSettings.sms && !mfaSettings.authenticator) {
                    document.getElementById('mfaEnabledToggle').checked = false;
                    mfaSettings.email = false;
                    mfaSettings.sms = false;
                    mfaSettings.authenticator = false;
                    saveMfaSettings();
                    updateMfaSettingsVisibility();
                    addNotification('MFA disabled (no verification methods selected)', 'info');
                } else {
                    addNotification(`Email verification ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                }
            });
            
            document.getElementById('mfaSmsEnabled').addEventListener('change', function() {
                mfaSettings.sms = this.checked;
                saveMfaSettings();
                
                // If all methods are disabled, disable MFA
                if (!mfaSettings.email && !mfaSettings.sms && !mfaSettings.authenticator) {
                    document.getElementById('mfaEnabledToggle').checked = false;
                    mfaSettings.email = false;
                    mfaSettings.sms = false;
                    mfaSettings.authenticator = false;
                    saveMfaSettings();
                    updateMfaSettingsVisibility();
                    addNotification('MFA disabled (no verification methods selected)', 'info');
                } else {
                    addNotification(`SMS verification ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                }
            });
            
            document.getElementById('mfaAuthenticatorEnabled').addEventListener('change', function() {
                mfaSettings.authenticator = this.checked;
                saveMfaSettings();
                
                // If all methods are disabled, disable MFA
                if (!mfaSettings.email && !mfaSettings.sms && !mfaSettings.authenticator) {
                    document.getElementById('mfaEnabledToggle').checked = false;
                    mfaSettings.email = false;
                    mfaSettings.sms = false;
                    mfaSettings.authenticator = false;
                    saveMfaSettings();
                    updateMfaSettingsVisibility();
                    addNotification('MFA disabled (no verification methods selected)', 'info');
                } else {
                    addNotification(`Authenticator app ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                }
            });
            
            // MFA for features toggles
            document.getElementById('mfaForSos').addEventListener('change', function() {
                mfaSettings.forSos = this.checked;
                saveMfaSettings();
                addNotification(`MFA for SOS alerts ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            document.getElementById('mfaForPassword').addEventListener('change', function() {
                mfaSettings.forPassword = this.checked;
                saveMfaSettings();
                addNotification(`MFA for password change ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            document.getElementById('mfaForContacts').addEventListener('change', function() {
                mfaSettings.forContacts = this.checked;
                saveMfaSettings();
                addNotification(`MFA for emergency contacts ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            document.getElementById('mfaForGovLogin').addEventListener('change', function() {
                mfaSettings.forGovLogin = this.checked;
                saveMfaSettings();
                addNotification(`MFA for government login ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            // Setup MFA button
            document.getElementById('setupMfaBtn').addEventListener('click', function() {
                addNotification('MFA setup instructions sent to your email', 'success');
            });
            
            // MFA method selection
            document.querySelectorAll('input[name="mfaMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Update UI based on selected method
                    const method = this.value;
                    const codeInput = document.getElementById('mfaCode');
                    
                    if (method === 'authenticator') {
                        codeInput.placeholder = 'Enter 6-digit code';
                    } else {
                        codeInput.placeholder = 'Enter verification code';
                    }
                });
            });
            
            // Verify MFA button
            document.getElementById('verifyMfaBtn').addEventListener('click', function() {
                const code = document.getElementById('mfaCode').value.trim();
                
                if (code.length === 0) {
                    addNotification('Please enter verification code', 'error');
                    return;
                }
                
                // Show loading state
                document.getElementById('mfaStatus').classList.remove('hidden');
                
                // Simulate verification
                setTimeout(() => {
                    document.getElementById('mfaStatus').classList.add('hidden');
                    
                    // Simple validation for demo (in real app, this would be server-side)
                    if (code === '123456' || code.length === 6) {
                        document.getElementById('mfaModal').classList.add('hidden');
                        document.getElementById('mfaCode').value = '';
                        stopMfaTimer();
                        
                        if (mfaVerificationCallback) {
                            mfaVerificationCallback(true);
                            mfaVerificationCallback = null;
                        }
                        
                        addNotification('Verification successful', 'success');
                    } else {
                        addNotification('Invalid verification code', 'error');
                    }
                }, 1500);
            });
            
            // Resend MFA code
            document.getElementById('resendMfaCode').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Reset timer
                resetMfaTimer();
                
                // Get selected method
                const method = document.querySelector('input[name="mfaMethod"]:checked').value;
                
                if (method === 'email') {
                    addNotification('Verification code resent to your email', 'success');
                } else if (method === 'sms') {
                    addNotification('Verification code resent to your phone', 'success');
                } else {
                    addNotification('Please check your authenticator app', 'success');
                }
            });
            
            // Close MFA modal
            document.getElementById('closeMfaModal').addEventListener('click', function() {
                document.getElementById('mfaModal').classList.add('hidden');
                document.getElementById('mfaCode').value = '';
                stopMfaTimer();
                
                if (mfaVerificationCallback) {
                    mfaVerificationCallback(false);
                    mfaVerificationCallback = null;
                }
            });
        }
        
        function saveMfaSettings() {
            localStorage.setItem('mfaSettings', JSON.stringify(mfaSettings));
        }
        
        function updateMfaSettingsVisibility() {
            const mfaEnabled = document.getElementById('mfaEnabledToggle').checked;
            const mfaSettingsDiv = document.getElementById('mfaSettings');
            
            if (mfaEnabled) {
                mfaSettingsDiv.classList.remove('hidden');
            } else {
                mfaSettingsDiv.classList.add('hidden');
            }
        }
        
        function showMfaVerification(action, callback) {
            // Check if MFA is enabled for this action
            let requireMfa = false;
            
            switch (action) {
                case 'sos':
                    requireMfa = mfaSettings.forSos;
                    break;
                case 'password':
                    requireMfa = mfaSettings.forPassword;
                    break;
                case 'contacts':
                    requireMfa = mfaSettings.forContacts;
                    break;
                case 'govLogin':
                    requireMfa = mfaSettings.forGovLogin;
                    break;
                default:
                    requireMfa = false;
            }
            
            // If MFA is not enabled for this action or not enabled at all, proceed without verification
            if (!requireMfa || (!mfaSettings.email && !mfaSettings.sms && !mfaSettings.authenticator)) {
                callback(true);
                return;
            }
            
            // Set callback
            mfaVerificationCallback = callback;
            
            // Reset form
            document.getElementById('mfaCode').value = '';
            
            // Show modal
            document.getElementById('mfaModal').classList.remove('hidden');
            
            // Start timer
            resetMfaTimer();
            
            // Generate a demo code (in real app, this would be sent to the user)
            mfaActionCode = '123456';
            
            // Show appropriate message based on selected method
            const method = document.querySelector('input[name="mfaMethod"]:checked').value;
            if (method === 'email') {
                addNotification('Verification code sent to your email', 'info');
            } else if (method === 'sms') {
                addNotification('Verification code sent to your phone', 'info');
            }
        }
        
        function resetMfaTimer() {
            stopMfaTimer();
            
            let timeLeft = 300; // 5 minutes in seconds
            
            updateMfaTimerDisplay(timeLeft);
            
            mfaTimerInterval = setInterval(() => {
                timeLeft--;
                updateMfaTimerDisplay(timeLeft);
                
                if (timeLeft <= 0) {
                    stopMfaTimer();
                    addNotification('Verification code expired', 'error');
                }
            }, 1000);
        }
        
        function updateMfaTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            document.getElementById('mfaTimer').textContent = 
                `Code expires in: ${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }
        
        function stopMfaTimer() {
            if (mfaTimerInterval) {
                clearInterval(mfaTimerInterval);
                mfaTimerInterval = null;
            }
        }
        
        // Linked Devices Functions
        function initLinkedDevices() {
            // Load linked devices from localStorage
            const savedDevices = localStorage.getItem('linkedDevices');
            if (savedDevices) {
                linkedDevices = JSON.parse(savedDevices);
            } else {
                // Initialize with current device
                linkedDevices = [
                    {
                        id: 'device-' + Date.now(),
                        name: 'Current Device',
                        type: 'smartphone',
                        location: 'Home',
                        lastActive: new Date().toISOString(),
                        isTrusted: true,
                        isCurrent: true
                    }
                ];
                saveLinkedDevices();
            }
            
            renderLinkedDevices();
            
            // Add device button
            const addDeviceBtn = document.getElementById('addDeviceBtn');
            if (addDeviceBtn) {
                addDeviceBtn.addEventListener('click', function() {
                    editingDeviceId = null;
                    document.getElementById('addDeviceForm').reset();
                    document.getElementById('addDeviceModal').classList.remove('hidden');
                });
            }
            
            // Close add device modal
            const closeAddDeviceModal = document.getElementById('closeAddDeviceModal');
            if (closeAddDeviceModal) {
                closeAddDeviceModal.addEventListener('click', function() {
                    document.getElementById('addDeviceModal').classList.add('hidden');
                });
            }
            
            // Add device form submission
            const addDeviceForm = document.getElementById('addDeviceForm');
            if (addDeviceForm) {
                addDeviceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get form data
                    const deviceData = {
                        name: document.getElementById('deviceName').value.trim(),
                        type: document.getElementById('deviceType').value,
                        location: document.getElementById('deviceLocation').value.trim(),
                        isTrusted: document.getElementById('deviceTrustedToggle').checked,
                        lastActive: new Date().toISOString(),
                        isCurrent: false
                    };
                    
                    // Validate form
                    if (!deviceData.name || !deviceData.type || !deviceData.location) {
                        addNotification('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    // Add device
                    if (editingDeviceId) {
                        // Update existing device
                        const index = linkedDevices.findIndex(d => d.id === editingDeviceId);
                        if (index !== -1) {
                            linkedDevices[index] = { ...linkedDevices[index], ...deviceData };
                        }
                        editingDeviceId = null;
                    } else {
                        // Add new device
                        const newDevice = {
                            id: 'device-' + Date.now(),
                            ...deviceData
                        };
                        linkedDevices.push(newDevice);
                    }
                    
                    saveLinkedDevices();
                    renderLinkedDevices();
                    document.getElementById('addDeviceModal').classList.add('hidden');
                    
                    const message = editingDeviceId ? 'Device updated successfully' : 'Device added successfully';
                    addNotification(message, 'success');
                });
            }
            
            // Device verification toggle
            const deviceVerificationToggle = document.getElementById('deviceVerificationToggle');
            if (deviceVerificationToggle) {
                // Load saved setting
                const savedSetting = localStorage.getItem('deviceVerification');
                if (savedSetting !== null) {
                    deviceVerificationToggle.checked = savedSetting === 'true';
                }
                
                deviceVerificationToggle.addEventListener('change', function() {
                    localStorage.setItem('deviceVerification', this.checked);
                    addNotification(`Device verification ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                });
            }
            
            // Device notification toggle
            const deviceNotificationToggle = document.getElementById('deviceNotificationToggle');
            if (deviceNotificationToggle) {
                // Load saved setting
                const savedSetting = localStorage.getItem('deviceNotification');
                if (savedSetting !== null) {
                    deviceNotificationToggle.checked = savedSetting === 'true';
                }
                
                deviceNotificationToggle.addEventListener('change', function() {
                    localStorage.setItem('deviceNotification', this.checked);
                    addNotification(`Device notifications ${this.checked ? 'enabled' : 'disabled'}`, 'success');
                });
            }
            
            // Logout all devices button
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            if (logoutAllDevicesBtn) {
                logoutAllDevicesBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to log out all devices except the current one?')) {
                        // Keep only current device
                        linkedDevices = linkedDevices.filter(device => device.isCurrent);
                        saveLinkedDevices();
                        renderLinkedDevices();
                        addNotification('All other devices logged out successfully', 'success');
                    }
                });
            }
        }
        
        function saveLinkedDevices() {
            localStorage.setItem('linkedDevices', JSON.stringify(linkedDevices));
        }
        
        function renderLinkedDevices() {
            const devicesList = document.getElementById('devicesList');
            const emptyMessage = document.getElementById('emptyDevicesMessage');
            
            if (!devicesList) return;
            
            devicesList.innerHTML = '';
            
            if (linkedDevices.length === 0) {
                emptyMessage.style.display = 'block';
                return;
            }
            
            emptyMessage.style.display = 'none';
            
            linkedDevices.forEach(device => {
                const deviceCard = document.createElement('div');
                deviceCard.className = 'card';
                
                // Get device icon based on type
                let deviceIcon = 'fas fa-mobile-alt';
                switch (device.type) {
                    case 'tablet':
                        deviceIcon = 'fas fa-tablet-alt';
                        break;
                    case 'laptop':
                        deviceIcon = 'fas fa-laptop';
                        break;
                    case 'smartwatch':
                        deviceIcon = 'fas fa-clock';
                        break;
                    case 'safety-band':
                        deviceIcon = 'fas fa-circle-notch';
                        break;
                }
                
                // Format last active time
                const lastActive = new Date(device.lastActive);
                const timeDiff = Date.now() - lastActive.getTime();
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                const daysDiff = Math.floor(hoursDiff / 24);
                
                let lastActiveText;
                if (daysDiff > 0) {
                    lastActiveText = `${daysDiff} day${daysDiff > 1 ? 's' : ''} ago`;
                } else if (hoursDiff > 0) {
                    lastActiveText = `${hoursDiff} hour${hoursDiff > 1 ? 's' : ''} ago`;
                } else {
                    lastActiveText = 'Just now';
                }
                
                deviceCard.innerHTML = `
                    <div class="flex align-center mb-2">
                        <i class="${deviceIcon}" style="font-size: 2rem; color: var(--primary-color); margin-right: 1rem;"></i>
                        <div>
                            <h4>${device.name} ${device.isCurrent ? '<span class="badge badge-success">Current</span>' : ''}</h4>
                            <p>${device.type.charAt(0).toUpperCase() + device.type.slice(1)}  ${device.location}</p>
                        </div>
                    </div>
                    <div class="flex align-center mb-2">
                        <i class="fas fa-clock" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        <span>Last active: ${lastActiveText}</span>
                    </div>
                    <div class="flex justify-between">
                        ${device.isTrusted ? '<span class="badge badge-success">Trusted</span>' : ''}
                        ${!device.isCurrent ? `
                        <button class="btn btn-danger btn-sm" onclick="removeDevice('${device.id}')">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                        ` : ''}
                        ${!device.isTrusted && !device.isCurrent ? `
                        <button class="btn btn-success btn-sm" onclick="trustDevice('${device.id}')">
                            <i class="fas fa-check"></i> Trust
                        </button>
                        ` : ''}
                    </div>
                `;
                devicesList.appendChild(deviceCard);
            });
        }
        
        function removeDevice(deviceId) {
            if (confirm('Are you sure you want to remove this device?')) {
                linkedDevices = linkedDevices.filter(d => d.id !== deviceId);
                saveLinkedDevices();
                renderLinkedDevices();
                addNotification('Device removed successfully', 'success');
            }
        }
        
        function trustDevice(deviceId) {
            const device = linkedDevices.find(d => d.id === deviceId);
            if (device) {
                device.isTrusted = true;
                saveLinkedDevices();
                renderLinkedDevices();
                addNotification(`${device.name} marked as trusted`, 'success');
            }
        }
        
        // Proactive SOS Functions
        function initProactiveSos() {
            // Load proactive SOS settings
            const savedProactiveSos = localStorage.getItem('proactiveSosEnabled');
            if (savedProactiveSos !== null) {
                proactiveSosEnabled = savedProactiveSos === 'true';
                document.getElementById('proactiveSosToggle').checked = proactiveSosEnabled;
            }
            
            const savedSensitivity = localStorage.getItem('sensitivityLevel');
            if (savedSensitivity !== null) {
                sensitivityLevel = parseInt(savedSensitivity);
                document.getElementById('sensitivitySlider').value = sensitivityLevel;
            }
            
            const savedMicrophone = localStorage.getItem('microphoneForDistress');
            if (savedMicrophone !== null) {
                microphoneForDistress = savedMicrophone === 'true';
                document.getElementById('microphoneForDistressToggle').checked = microphoneForDistress;
            }
            
            const savedFallDetection = localStorage.getItem('fallDetectionEnabled');
            if (savedFallDetection !== null) {
                fallDetectionEnabled = savedFallDetection === 'true';
                document.getElementById('fallDetectionToggle').checked = fallDetectionEnabled;
            }
            
            const savedMovementDetection = localStorage.getItem('movementDetectionEnabled');
            if (savedMovementDetection !== null) {
                movementDetectionEnabled = savedMovementDetection === 'true';
                document.getElementById('movementDetectionToggle').checked = movementDetectionEnabled;
            }
            
            // Load user behavior model
            const savedBehaviorModel = localStorage.getItem('userBehaviorModel');
            if (savedBehaviorModel) {
                try {
                    userBehaviorModel = JSON.parse(savedBehaviorModel);
                } catch (e) {
                    console.error('Error parsing user behavior model:', e);
                }
            }
            
            // Update UI
            updateProactiveSosSettingsVisibility();
            
            // Proactive SOS toggle
            document.getElementById('proactiveSosToggle').addEventListener('change', function() {
                proactiveSosEnabled = this.checked;
                localStorage.setItem('proactiveSosEnabled', proactiveSosEnabled);
                updateProactiveSosSettingsVisibility();
                
                if (proactiveSosEnabled) {
                    startProactiveSos();
                    addNotification('Proactive SOS enabled', 'success');
                } else {
                    stopProactiveSos();
                    addNotification('Proactive SOS disabled', 'info');
                }
            });
            
            // Sensitivity slider
            document.getElementById('sensitivitySlider').addEventListener('change', function() {
                sensitivityLevel = parseInt(this.value);
                localStorage.setItem('sensitivityLevel', sensitivityLevel);
            });
            
            // Microphone for distress toggle
            document.getElementById('microphoneForDistressToggle').addEventListener('change', function() {
                microphoneForDistress = this.checked;
                localStorage.setItem('microphoneForDistress', microphoneForDistress);
                
                if (microphoneForDistress && proactiveSosEnabled) {
                    initVoiceRecognitionForDistress();
                } else if (voiceRecognitionForDistress) {
                    voiceRecognitionForDistress.stop();
                }
            });
            
            // Fall detection toggle
            document.getElementById('fallDetectionToggle').addEventListener('change', function() {
                fallDetectionEnabled = this.checked;
                localStorage.setItem('fallDetectionEnabled', fallDetectionEnabled);
            });
            
            // Movement detection toggle
            document.getElementById('movementDetectionToggle').addEventListener('change', function() {
                movementDetectionEnabled = this.checked;
                localStorage.setItem('movementDetectionEnabled', movementDetectionEnabled);
            });
            
            // Test proactive SOS button
            document.getElementById('testProactiveSosBtn').addEventListener('click', function() {
                // Simulate a potential emergency
                showProactiveSosVerification('Test emergency detected by AI/ML system');
            });
            
            // Proactive SOS modal buttons
            document.getElementById('closeProactiveSosModal').addEventListener('click', function() {
                document.getElementById('proactiveSosVerificationModal').classList.add('hidden');
                stopProactiveSosCountdown();
            });
            
            document.getElementById('confirmProactiveSosBtn').addEventListener('click', function() {
                document.getElementById('proactiveSosVerificationModal').classList.add('hidden');
                stopProactiveSosCountdown();
                
                // Send SOS
                sendSOSAlert();
            });
            
            document.getElementById('cancelProactiveSosBtn').addEventListener('click', function() {
                document.getElementById('proactiveSosVerificationModal').classList.add('hidden');
                stopProactiveSosCountdown();
                
                addNotification('Proactive SOS cancelled. Your safety is confirmed.', 'success');
            });
            
            // Start proactive SOS if enabled
            if (proactiveSosEnabled) {
                startProactiveSos();
            }
        }
        
        function updateProactiveSosSettingsVisibility() {
            const proactiveSosSettings = document.getElementById('proactiveSosSettings');
            
            if (proactiveSosEnabled) {
                proactiveSosSettings.classList.remove('hidden');
                
                // Show AI status card on home page
                document.getElementById('aiStatusCard').style.display = 'block';
            } else {
                proactiveSosSettings.classList.add('hidden');
                
                // Hide AI status card on home page
                document.getElementById('aiStatusCard').style.display = 'none';
            }
        }
        
        function startProactiveSos() {
            if (proactiveSosInterval) {
                clearInterval(proactiveSosInterval);
            }
            
            // Start monitoring user behavior
            proactiveSosInterval = setInterval(() => {
                monitorUserBehavior();
            }, 30000); // Check every 30 seconds
            
            // Initialize voice recognition for distress detection if enabled
            if (microphoneForDistress) {
                initVoiceRecognitionForDistress();
            }
            
            // Update AI status
            updateAiStatus('Monitoring', 'Low');
        }
        
        function stopProactiveSos() {
            if (proactiveSosInterval) {
                clearInterval(proactiveSosInterval);
                proactiveSosInterval = null;
            }
            
            // Stop voice recognition for distress detection
            if (voiceRecognitionForDistress && isListeningForDistress) {
                voiceRecognitionForDistress.stop();
            }
            
            // Update AI status
            updateAiStatus('Inactive', 'Low');
        }
        
        function initVoiceRecognitionForDistress() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognitionForDistress = new SpeechRecognition();
                
                voiceRecognitionForDistress.continuous = true;
                voiceRecognitionForDistress.interimResults = true;
                voiceRecognitionForDistress.lang = 'en-US';
                
                voiceRecognitionForDistress.onresult = function(event) {
                    let transcript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            transcript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (transcript) {
                        checkForDistressKeywords(transcript.toLowerCase());
                    }
                };
                
                voiceRecognitionForDistress.onerror = function(event) {
                    console.error('Speech recognition error for distress detection:', event.error);
                    
                    // Try to restart after a delay
                    setTimeout(() => {
                        if (microphoneForDistress && proactiveSosEnabled && !isListeningForDistress) {
                            try {
                                voiceRecognitionForDistress.start();
                                isListeningForDistress = true;
                            } catch (e) {
                                console.error('Failed to restart voice recognition for distress detection:', e);
                            }
                        }
                    }, 5000);
                };
                
                voiceRecognitionForDistress.onend = function() {
                    isListeningForDistress = false;
                    
                    // Restart if still enabled
                    if (microphoneForDistress && proactiveSosEnabled) {
                        try {
                            voiceRecognitionForDistress.start();
                            isListeningForDistress = true;
                        } catch (e) {
                            console.error('Failed to restart voice recognition for distress detection:', e);
                        }
                    }
                };
                
                // Start listening
                try {
                    voiceRecognitionForDistress.start();
                    isListeningForDistress = true;
                } catch (e) {
                    console.error('Failed to start voice recognition for distress detection:', e);
                }
            } else {
                console.error('Voice recognition for distress detection not supported');
                microphoneForDistress = false;
                document.getElementById('microphoneForDistressToggle').checked = false;
                localStorage.setItem('microphoneForDistress', false);
            }
        }
        
        function checkForDistressKeywords(transcript) {
            const distressKeywords = [
                'help', 'help me', 'save me', 'emergency', 'sos',
                'danger', 'attack', 'assault', 'theft', 'robbery',
                'accident', 'hurt', 'injured', 'bleeding', 'pain'
            ];
            
            let keywordFound = false;
            let foundKeyword = '';
            
            for (const keyword of distressKeywords) {
                if (transcript.includes(keyword)) {
                    keywordFound = true;
                    foundKeyword = keyword;
                    break;
                }
            }
            
            if (keywordFound) {
                console.log(`Distress keyword detected: ${foundKeyword}`);
                
                // Increase threat level based on sensitivity
                const currentThreatLevel = getThreatLevel();
                const newThreatLevel = Math.min(currentThreatLevel + (sensitivityLevel * 15), 100);
                
                updateAiStatus('Potential distress detected', newThreatLevel);
                
                // If threat level is high enough, show verification
                if (newThreatLevel >= 70) {
                    showProactiveSosVerification(`Distress keyword "${foundKeyword}" detected`);
                }
            }
        }
        
        function monitorUserBehavior() {
            // In a real app, this would collect actual sensor data
            // For demo purposes, we'll simulate random behavior patterns
            
            // Simulate movement data
            const movementData = {
                acceleration: Math.random() * 20,
                speed: Math.random() * 5,
                locationChange: Math.random() > 0.7
            };
            
            // Simulate location data
            const locationData = {
                latitude: 28.6139 + (Math.random() - 0.5) * 0.01,
                longitude: 77.2090 + (Math.random() - 0.5) * 0.01,
                accuracy: Math.random() * 50
            };
            
            // Simulate time of day
            const hour = new Date().getHours();
            const isNightTime = hour < 6 || hour > 20;
            
            // Update user behavior model
            updateUserBehaviorModel(movementData, locationData);
            
            // Analyze behavior for anomalies
            const anomalyScore = analyzeBehaviorForAnomalies(movementData, locationData, isNightTime);
            
            // Update threat level based on anomaly score
            if (anomalyScore > 0) {
                const currentThreatLevel = getThreatLevel();
                const newThreatLevel = Math.min(currentThreatLevel + anomalyScore, 100);
                
                updateAiStatus('Anomaly detected', newThreatLevel);
                
                // If threat level is high enough, show verification
                if (newThreatLevel >= 70) {
                    let reason = 'Unusual behavior pattern detected';
                    
                    if (movementData.acceleration > 15 && fallDetectionEnabled) {
                        reason = 'Potential fall detected';
                    } else if (movementData.speed < 0.5 && movementData.locationChange && movementDetectionEnabled) {
                        reason = 'Unusually long stop detected';
                    } else if (isNightTime && locationData.accuracy > 30) {
                        reason = 'Unusual location at night';
                    }
                    
                    showProactiveSosVerification(reason);
                }
            } else {
                // Gradually decrease threat level if no anomalies
                const currentThreatLevel = getThreatLevel();
                if (currentThreatLevel > 15) {
                    updateAiStatus('Monitoring', Math.max(currentThreatLevel - 5, 15));
                }
            }
        }
        
        function updateUserBehaviorModel(movementData, locationData) {
            // Add current data to behavior model
            userBehaviorModel.normalMovementPatterns.push(movementData);
            userBehaviorModel.normalLocations.push(locationData);
            
            const now = new Date();
            userBehaviorModel.normalActivityTimes.push(now.getHours() * 60 + now.getMinutes());
            
            // Keep only the last 100 data points
            if (userBehaviorModel.normalMovementPatterns.length > 100) {
                userBehaviorModel.normalMovementPatterns.shift();
                userBehaviorModel.normalLocations.shift();
                userBehaviorModel.normalActivityTimes.shift();
            }
            
            // Save model periodically
            if (now - userBehaviorModel.lastCalibration > 24 * 60 * 60 * 1000) { // Once a day
                localStorage.setItem('userBehaviorModel', JSON.stringify(userBehaviorModel));
                userBehaviorModel.lastCalibration = now;
            }
        }
        
        function analyzeBehaviorForAnomalies(movementData, locationData, isNightTime) {
            let anomalyScore = 0;
            
            // Check for potential fall
            if (fallDetectionEnabled && movementData.acceleration > 15) {
                anomalyScore += 30;
            }
            
            // Check for unusual movement (too slow or too fast)
            if (movementDetectionEnabled) {
                if (movementData.speed < 0.5 && movementData.locationChange) {
                    // Unusually long stop
                    anomalyScore += 20;
                } else if (movementData.speed > 4) {
                    // Unusually fast movement
                    anomalyScore += 15;
                }
            }
            
            // Check for unusual location at night
            if (isNightTime && locationData.accuracy > 30) {
                anomalyScore += 25;
            }
            
            // Adjust based on sensitivity level
            anomalyScore *= (sensitivityLevel / 2);
            
            return anomalyScore;
        }
        
        function getThreatLevel() {
            const threatProgressBar = document.getElementById('threatProgressBar');
            return parseInt(threatProgressBar.style.width) || 15;
        }
        
        function updateAiStatus(status, threatLevel) {
            document.getElementById('aiStatusText').textContent = status;
            document.getElementById('threatLevel').textContent = 
                threatLevel < 30 ? 'Low' : 
                threatLevel < 70 ? 'Medium' : 'High';
            
            const threatProgressBar = document.getElementById('threatProgressBar');
            threatProgressBar.style.width = threatLevel + '%';
            
            // Update color based on threat level
            if (threatLevel < 30) {
                threatProgressBar.style.backgroundColor = 'var(--success-color)';
                document.getElementById('aiStatusIndicator').classList.add('normal');
                document.getElementById('aiStatusIndicator').classList.remove('warning', 'critical');
            } else if (threatLevel < 70) {
                threatProgressBar.style.backgroundColor = 'var(--warning-color)';
                document.getElementById('aiStatusIndicator').classList.add('warning');
                document.getElementById('aiStatusIndicator').classList.remove('normal', 'critical');
            } else {
                threatProgressBar.style.backgroundColor = 'var(--danger-color)';
                document.getElementById('aiStatusIndicator').classList.add('critical');
                document.getElementById('aiStatusIndicator').classList.remove('normal', 'warning');
            }
        }
        
        function showProactiveSosVerification(reason) {
            document.getElementById('proactiveSosReason').textContent = reason;
            document.getElementById('proactiveSosVerificationModal').classList.remove('hidden');
            startProactiveSosCountdown();
        }
        
        let proactiveSosCountdownInterval;
        function startProactiveSosCountdown() {
            let countdown = 10;
            document.getElementById('proactiveSosCountdown').textContent = countdown;
            
            proactiveSosCountdownInterval = setInterval(function() {
                countdown--;
                document.getElementById('proactiveSosCountdown').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(proactiveSosCountdownInterval);
                    document.getElementById('proactiveSosVerificationModal').classList.add('hidden');
                    
                    // Automatically trigger SOS
                    sendSOSAlert();
                }
            }, 1000);
        }
        
        function stopProactiveSosCountdown() {
            if (proactiveSosCountdownInterval) {
                clearInterval(proactiveSosCountdownInterval);
                proactiveSosCountdownInterval = null;
            }
        }
    </script>
</body>
</html>